<!DOCTYPE html>  <html> <head>   <title>batman.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               batman.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>batman.js</p>

<p>Created by Nick Small
Copyright 2011, Shopify</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The global namespace, the <code>Batman</code> function will also create also create a new
instance of Batman.Object and mixin all arguments to it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman = </span><span class="nf">(mixins...) -&gt;</span>
  <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span> <span class="nx">mixins</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Global Helpers</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><code>$typeOf</code> returns a string that contains the built-in class of an object
like <code>String</code>, <code>Array</code>, or <code>Object</code>. Note that only <code>Object</code> will be returned for
the entire prototype chain.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.typeOf = $typeOf = </span><span class="nf">(object) -&gt;</span>
  <span class="nx">_objectToString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Cache this function to skip property lookups.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_objectToString = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><code>$mixin</code> applies every key from every argument after the first to the
first argument. If a mixin has an <code>initialize</code> method, it will be called in
the context of the <code>to</code> object, and it's key/values won't be applied.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.mixin = $mixin = </span><span class="nf">(to, mixins...) -&gt;</span>
  <span class="nv">hasSet = </span><span class="k">typeof</span> <span class="nx">to</span><span class="p">.</span><span class="nx">set</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>

  <span class="k">for</span> <span class="nx">mixin</span> <span class="k">in</span> <span class="nx">mixins</span>
    <span class="k">continue</span> <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">mixin</span><span class="p">)</span> <span class="o">isnt</span> <span class="s1">&#39;Object&#39;</span>

    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">mixin</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">key</span> <span class="k">in</span>  <span class="p">[</span><span class="s1">&#39;initialize&#39;</span><span class="p">,</span> <span class="s1">&#39;uninitialize&#39;</span><span class="p">,</span> <span class="s1">&#39;prototype&#39;</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">hasSet</span>
        <span class="nx">to</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">to</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">mixin</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nx">mixin</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="nx">to</span>

  <span class="nx">to</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><code>$unmixin</code> removes every key/value from every argument after the first
from the first argument. If a mixin has a <code>deinitialize</code> method, it will be
called in the context of the <code>from</code> object and won't be removed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.unmixin = $unmixin = </span><span class="nf">(from, mixins...) -&gt;</span>
  <span class="k">for</span> <span class="nx">mixin</span> <span class="k">in</span> <span class="nx">mixins</span>
    <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">mixin</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">key</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;initialize&#39;</span><span class="p">,</span> <span class="s1">&#39;uninitialize&#39;</span><span class="p">]</span>

      <span class="k">delete</span> <span class="nx">from</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">mixin</span><span class="p">.</span><span class="nx">uninitialize</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nx">mixin</span><span class="p">.</span><span class="nx">uninitialize</span><span class="p">.</span><span class="nx">call</span> <span class="nx">from</span>

  <span class="nx">from</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><code>$block</code> takes in a function and returns a function which can either
  A) take a callback as its last argument as it would normally, or
  B) accept a callback as a second function application.
This is useful so that multiline functions can be passed as callbacks
without the need for wrapping brackets (which a CoffeeScript bug
requires them to have). <code>$block</code> also takes an optional function airity
argument as the first argument. If a <code>length</code> argument is given, and <code>length</code>
or more arguments are passed, <code>$block</code> will call the second argument
(the function) with the passed arguments, regardless of their type.
Example:
 With a function that accepts a callback as its last argument</p>

<pre><code>f = (a, b, callback) -&gt; callback(a + b)
ex = $block f
</code></pre>

<p>We can use $block to make it accept the callback in both ways:</p>

<pre><code>ex(2, 3, (x) -&gt; alert(x))  # alerts 5
</code></pre>

<p>or</p>

<pre><code>ex(2, 3) (x) -&gt; alert(x)
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman._block = $block = </span><span class="nf">(lengthOrFunction, fn) -&gt;</span>
  <span class="k">if</span> <span class="nx">fn</span><span class="o">?</span>
    <span class="nv">argsLength = </span><span class="nx">lengthOrFunction</span>
  <span class="k">else</span>
    <span class="nv">fn = </span><span class="nx">lengthOrFunction</span>

  <span class="nv">callbackEater = </span><span class="nf">(args...) -&gt;</span>
    <span class="nv">ctx = </span><span class="err">@</span>
    <span class="nv">f = </span><span class="nf">(callback) -&gt;</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">push</span> <span class="nx">callback</span>
      <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Call the function right now if we've been passed the callback already or if we've reached the argument count threshold</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">argsLength</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">argsLength</span><span class="p">))</span>
      <span class="nx">f</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">())</span>
    <span class="k">else</span>
      <span class="nx">f</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><code>findName</code> allows an anonymous function to find out what key it resides
in within a context.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman._findName = $findName = </span><span class="nf">(f, context) -&gt;</span>
  <span class="nx">unless</span> <span class="nx">f</span><span class="p">.</span><span class="nx">displayName</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">context</span>
      <span class="k">if</span> <span class="nx">value</span> <span class="o">is</span> <span class="nx">f</span>
        <span class="nv">f.displayName = </span><span class="nx">key</span>
        <span class="k">break</span>

  <span class="nx">f</span><span class="p">.</span><span class="nx">displayName</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Properties</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span>
  <span class="vi">@defaultAccessor:</span>
    <span class="nv">get: </span><span class="nf">(key) -&gt;</span> <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nv">set: </span><span class="nf">(key, val) -&gt;</span> <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
    <span class="nv">unset: </span><span class="nf">(key) -&gt;</span> <span class="nv">x = </span><span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="k">delete</span> <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="nx">x</span>
  <span class="vi">@triggerTracker: </span><span class="kc">null</span>
  <span class="vi">@forBaseAndKey: </span><span class="nf">(base, key) -&gt;</span>
    <span class="k">if</span> <span class="nx">base</span><span class="p">.</span><span class="nx">_batman</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="nx">base</span>
      <span class="nv">properties = </span><span class="nx">base</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">properties</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
      <span class="nx">properties</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">or</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="k">new</span> <span class="err">@</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="k">new</span> <span class="err">@</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="nv">constructor: </span><span class="nf">(@base, @key) -&gt;</span>
  <span class="nv">isProperty: </span><span class="kc">true</span>
  <span class="nv">accessor: </span><span class="o">-&gt;</span>
    <span class="nv">accessors = </span><span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;keyAccessors&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">accessors</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">val = </span><span class="nx">accessors</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">@key</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">val</span>
    <span class="k">else</span>
      <span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">getFirst</span><span class="p">(</span><span class="s1">&#39;defaultAccessor&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">defaultAccessor</span>

  <span class="nv">registerAsTrigger: </span><span class="o">-&gt;</span>
    <span class="nx">tracker</span><span class="p">.</span><span class="nx">add</span> <span class="err">@</span> <span class="k">if</span> <span class="nv">tracker = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">triggerTracker</span>
  <span class="nv">getValue: </span><span class="o">-&gt;</span>
    <span class="nx">@registerAsTrigger</span><span class="p">()</span>
    <span class="nx">@accessor</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@base</span><span class="p">,</span> <span class="nx">@key</span>
  <span class="nv">setValue: </span><span class="nf">(val) -&gt;</span>
    <span class="nx">@accessor</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@base</span><span class="p">,</span> <span class="nx">@key</span><span class="p">,</span> <span class="nx">val</span>
  <span class="nv">unsetValue: </span><span class="o">-&gt;</span> <span class="nx">@accessor</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">unset</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@base</span><span class="p">,</span> <span class="nx">@key</span>
  <span class="nv">isEqual: </span><span class="nf">(other) -&gt;</span>
    <span class="nx">@constructor</span> <span class="o">is</span> <span class="nx">other</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">and</span> <span class="nx">@base</span> <span class="o">is</span> <span class="nx">other</span><span class="p">.</span><span class="nx">base</span> <span class="o">and</span> <span class="nx">@key</span> <span class="o">is</span> <span class="nx">other</span><span class="p">.</span><span class="nx">key</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ObservableProperty</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span>
  <span class="nv">constructor: </span><span class="nf">(base, key) -&gt;</span>
    <span class="k">super</span>
    <span class="vi">@observers = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
    <span class="nx">@refreshTriggers</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@hasObserversToFire</span><span class="p">()</span>
    <span class="vi">@_preventCount = </span><span class="mi">0</span>
  <span class="nv">setValue: </span><span class="nf">(val) -&gt;</span>
    <span class="nx">@cacheDependentValues</span><span class="p">()</span>
    <span class="k">super</span>
    <span class="nx">@fireDependents</span><span class="p">()</span>
    <span class="nx">val</span>
  <span class="nv">unsetValue: </span><span class="o">-&gt;</span>
    <span class="nx">@cacheDependentValues</span><span class="p">()</span>
    <span class="k">super</span>
    <span class="nx">@fireDependents</span><span class="p">()</span>
    <span class="k">return</span>
  <span class="nv">cacheDependentValues: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@dependents</span>
      <span class="nx">@dependents</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(prop) -&gt;</span> <span class="nv">prop.cachedValue = </span><span class="nx">prop</span><span class="p">.</span><span class="nx">getValue</span><span class="p">()</span>
  <span class="nv">fireDependents: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@dependents</span>
      <span class="nx">@dependents</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(prop) -&gt;</span>
        <span class="nx">prop</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(),</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">cachedValue</span><span class="p">)</span> <span class="k">if</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">hasObserversToFire</span><span class="o">?</span><span class="p">()</span>
  <span class="nv">observe: </span><span class="nf">(fireImmediately..., callback) -&gt;</span>
    <span class="nv">fireImmediately = </span><span class="nx">fireImmediately</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="kc">true</span>
    <span class="nv">currentValue = </span><span class="nx">@getValue</span><span class="p">()</span>
    <span class="nx">@observers</span><span class="p">.</span><span class="nx">add</span> <span class="nx">callback</span>
    <span class="nx">@refreshTriggers</span><span class="p">()</span>
    <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@base</span><span class="p">,</span> <span class="nx">currentValue</span><span class="p">,</span> <span class="nx">currentValue</span><span class="p">)</span> <span class="k">if</span> <span class="nx">fireImmediately</span>
    <span class="err">@</span>
  <span class="nv">hasObserversToFire: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">@observers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span>
      <span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">ancestors</span><span class="p">().</span><span class="nx">some</span><span class="p">((</span><span class="nx">ancestor</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">property</span><span class="o">?</span><span class="p">(</span><span class="nx">@key</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">observers</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="kc">false</span>
  <span class="nv">prevent: </span><span class="o">-&gt;</span> <span class="nx">@_preventCount</span><span class="o">++</span>
  <span class="nv">allow: </span><span class="o">-&gt;</span> <span class="nx">@_preventCount</span><span class="o">--</span> <span class="k">if</span> <span class="nx">@_preventCount</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="nv">isAllowedToFire: </span><span class="o">-&gt;</span> <span class="nx">@_preventCount</span> <span class="o">&lt;=</span> <span class="mi">0</span>
  <span class="nv">fire: </span><span class="nf">(args...) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@isAllowedToFire</span><span class="p">()</span> <span class="o">and</span> <span class="nx">@hasObserversToFire</span><span class="p">()</span>
    <span class="nv">key = </span><span class="nx">@key</span>
    <span class="nv">base = </span><span class="nx">@base</span>
    <span class="nv">observerSets = </span><span class="p">[</span><span class="nx">@observers</span><span class="p">]</span>
    <span class="nx">@observers</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(callback) -&gt;</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">base</span><span class="p">,</span> <span class="nx">args</span>
    <span class="k">if</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span>
      <span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">ancestors</span> <span class="nf">(ancestor) -&gt;</span>
        <span class="nx">ancestor</span><span class="p">.</span><span class="nx">property</span><span class="o">?</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">observers</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(callback) -&gt;</span>
          <span class="nx">callback</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">base</span><span class="p">,</span> <span class="nx">args</span>
    <span class="nx">@refreshTriggers</span><span class="p">()</span>
  <span class="nv">forget: </span><span class="nf">(observer) -&gt;</span>
    <span class="k">if</span> <span class="nx">observer</span>
      <span class="nx">@observers</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">observer</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="vi">@observers = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
    <span class="nx">@clearTriggers</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">@hasObserversToFire</span><span class="p">()</span>
  <span class="nv">refreshTriggers: </span><span class="o">-&gt;</span>
    <span class="nv">Batman.Property.triggerTracker = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
    <span class="nx">@getValue</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">@triggers</span>
      <span class="nx">@triggers</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">unless</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">triggerTracker</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span>
          <span class="nx">property</span><span class="p">.</span><span class="nx">dependents</span><span class="o">?</span><span class="p">.</span><span class="nx">remove</span> <span class="err">@</span>
    <span class="vi">@triggers = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">triggerTracker</span>
    <span class="nx">@triggers</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">property</span><span class="p">.</span><span class="nx">dependents</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
      <span class="nx">property</span><span class="p">.</span><span class="nx">dependents</span><span class="p">.</span><span class="nx">add</span> <span class="err">@</span>
    <span class="k">delete</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">triggerTracker</span>
  <span class="nv">clearTriggers: </span><span class="o">-&gt;</span>
    <span class="nx">@triggers</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">property</span><span class="p">.</span><span class="nx">dependents</span><span class="p">.</span><span class="nx">remove</span> <span class="err">@</span>
    <span class="vi">@triggers = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>Keypaths</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Keypath</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ObservableProperty</span>
  <span class="nv">constructor: </span><span class="nf">(base, key) -&gt;</span>
    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;String&#39;</span>
      <span class="vi">@segments = </span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
      <span class="vi">@depth = </span><span class="nx">@segments</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">else</span>
      <span class="vi">@segments = </span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="vi">@depth = </span><span class="mi">1</span>
    <span class="k">super</span>
  <span class="nv">slice: </span><span class="nf">(begin, end = @depth) -&gt;</span>
    <span class="nv">base = </span><span class="nx">@base</span>
    <span class="k">for</span> <span class="nx">segment</span> <span class="k">in</span> <span class="nx">@segments</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">begin</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">base</span><span class="o">?</span> <span class="o">and</span> <span class="nv">base = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Keypath</span><span class="p">.</span><span class="nx">forBaseAndKey</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">segment</span><span class="p">).</span><span class="nx">getValue</span><span class="p">()</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">Keypath</span><span class="p">.</span><span class="nx">forBaseAndKey</span> <span class="nx">base</span><span class="p">,</span> <span class="nx">@segments</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">begin</span><span class="p">,</span> <span class="nx">end</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
  <span class="nv">terminalProperty: </span><span class="o">-&gt;</span> <span class="nx">@slice</span> <span class="o">-</span><span class="mi">1</span>
  <span class="nv">getValue: </span><span class="o">-&gt;</span>
    <span class="nx">@registerAsTrigger</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">@depth</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">super</span> <span class="k">else</span> <span class="nx">@terminalProperty</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">getValue</span><span class="p">()</span>
  <span class="nv">setValue: </span><span class="nf">(val) -&gt;</span> <span class="k">if</span> <span class="nx">@depth</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">super</span> <span class="k">else</span> <span class="nx">@terminalProperty</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
  <span class="nv">unsetValue: </span><span class="o">-&gt;</span> <span class="k">if</span> <span class="nx">@depth</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">super</span> <span class="k">else</span> <span class="nx">@terminalProperty</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">unsetValue</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h2>Observable</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Batman.Observable is a generic mixin that can be applied to any object to allow it to be bound to.
It is applied by default to every instance of <code>Batman.Object</code> and subclasses.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.Observable =</span>
  <span class="nv">isObservable: </span><span class="kc">true</span>
  <span class="nv">property: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">Keypath</span><span class="p">.</span><span class="nx">forBaseAndKey</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="nv">get: </span><span class="nf">(key) -&gt;</span>
    <span class="k">return</span> <span class="kc">undefined</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">getValue</span><span class="p">()</span>
  <span class="nv">set: </span><span class="nf">(key, val) -&gt;</span>
    <span class="k">return</span> <span class="kc">undefined</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
  <span class="nv">unset: </span><span class="nf">(key) -&gt;</span>
    <span class="k">return</span> <span class="kc">undefined</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">unsetValue</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><code>forget</code> removes an observer from an object. If the callback is passed in,
its removed. If no callback but a key is passed in, all the observers on
that key are removed. If no key is passed in, all observers are removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">forget: </span><span class="nf">(key, observer) -&gt;</span>
    <span class="k">if</span> <span class="nx">key</span>
      <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">forget</span><span class="p">(</span><span class="nx">observer</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@_batman</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(key, property) -&gt;</span> <span class="nx">property</span><span class="p">.</span><span class="nx">forget</span><span class="p">()</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p><code>allowed</code> returns a boolean describing whether or not the key is
currently allowed to fire its observers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">allowed: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">isAllowedToFire</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p><code>fire</code> tells any observers attached to a key to fire, manually.
<code>prevent</code> stops of a given binding from firing. <code>prevent</code> calls can be repeated such that
the same number of calls to allow are needed before observers can be fired.
<code>allow</code> unblocks a property for firing observers. Every call to prevent
must have a matching call to allow later if observers are to be fired.
<code>observe</code> takes a key and a callback. Whenever the value for that key changes, your
callback will be called in the context of the original object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;observe&#39;</span><span class="p">,</span> <span class="s1">&#39;prevent&#39;</span><span class="p">,</span> <span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;fire&#39;</span><span class="p">]</span>
  <span class="nx">do</span> <span class="nf">(k) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(key, args...) -&gt;</span>
      <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">)[</span><span class="nx">k</span><span class="p">](</span><span class="nx">args</span><span class="p">...)</span>
      <span class="err">@</span>

<span class="nv">$get = Batman.get = </span><span class="nf">(object, key) -&gt;</span>
  <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">get</span>
    <span class="nx">object</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h2>Events</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p><code>Batman.EventEmitter</code> is another generic mixin that simply allows an object to
emit events. Batman events use observers to manage the callbacks, so they require that
the object emitting the events be observable. If events need to be attached to an object
which isn't a <code>Batman.Object</code> or doesn't have the <code>Batman.Observable</code> and <code>Batman.EventEmitter</code>
mixins applied, the $event function can be used to create ephemeral event objects which
use those mixins internally.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.EventEmitter =</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>An event is a convenient observer wrapper. Any function can be wrapped in an event, and
when called, it will cause it's object to fire all the observers for that event. There is
also some syntactical sugar so observers can be registered simply by calling the event with a
function argument. Notice that the <code>$block</code> helper is used here so events can be declared in
class definitions using the second function application syntax and no wrapping brackets.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">event: </span><span class="nx">$block</span> <span class="nf">(key, context, callback) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">callback</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">context</span> <span class="o">isnt</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="nv">callback = </span><span class="nx">context</span>
      <span class="nv">context = </span><span class="kc">null</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">callback</span> <span class="o">and</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">isnt</span> <span class="s1">&#39;String&#39;</span>
      <span class="nv">callback = </span><span class="nx">key</span>
      <span class="nv">key = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Return a function which either takes another observer
to register or a value to fire the event with.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">f = </span><span class="nf">(observer) -&gt;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">@observe</span>
        <span class="k">throw</span> <span class="s2">&quot;EventEmitter requires Observable&quot;</span>

      <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>

      <span class="nx">key</span> <span class="o">||=</span> <span class="nx">$findName</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>
      <span class="nv">fired = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">oneShotFired</span><span class="o">?</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Pass a function to the event to register it as an observer.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">observer</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
        <span class="nx">@observe</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">observer</span>
        <span class="nx">observer</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">_firedArgs</span><span class="p">)</span> <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">isOneShot</span> <span class="o">and</span> <span class="nx">fired</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Otherwise, calling the event will cause it to fire. Any
arguments you pass will be passed to your wrapped function.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span> <span class="nx">@allowed</span> <span class="nx">key</span>
        <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">isOneShot</span> <span class="o">and</span> <span class="nx">fired</span>
        <span class="nv">value = </span><span class="nx">callback</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Observers will only fire if the result of the event is not false.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">value</span> <span class="o">isnt</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Get and cache the arguments for the event listeners. Add the value if
its not undefined, and then concat any more arguments passed to this
event when fired.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">f._firedArgs = </span><span class="nx">unless</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
              <span class="p">[</span><span class="nx">value</span><span class="p">].</span><span class="nx">concat</span> <span class="nx">arguments</span><span class="p">...</span>
            <span class="k">else</span>
              <span class="k">if</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="p">[]</span>
              <span class="k">else</span>
                <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span> <span class="nx">arguments</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Copy the array and add in the key for <code>fire</code></p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">args = </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span> <span class="nx">f</span><span class="p">.</span><span class="nx">_firedArgs</span>
          <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">key</span>
          <span class="nx">@fire</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span>

          <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">isOneShot</span>
            <span class="nv">firings = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">oneShotFired</span> <span class="o">||=</span> <span class="p">{}</span>
            <span class="nx">firings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">yes</span>

        <span class="nx">value</span>
      <span class="k">else</span>
        <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>This could be its own mixin but is kept here for brevity.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">f = </span><span class="nx">f</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="k">if</span> <span class="nx">context</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">f</span> <span class="k">if</span> <span class="nx">key</span><span class="o">?</span>
    <span class="nx">$mixin</span> <span class="nx">f</span><span class="p">,</span>
      <span class="nv">isEvent: </span><span class="kc">yes</span>
      <span class="nv">action: </span><span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>One shot events can be used for something that only fires once. Any observers
added after it has already fired will simply be executed immediately. This is useful
for things like <code>ready</code> events on requests or renders, because once ready they always
remain ready. If an AJAX request had a vanilla <code>ready</code> event, observers attached after
the ready event fired the first time would never fire, as they would be waiting for
the next time <code>ready</code> would fire as is standard with vanilla events. With a one shot
event, any observers attached after the first fire will fire immediately, meaning no logic</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">eventOneShot: </span><span class="nf">(callback) -&gt;</span>
    <span class="nx">$mixin</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span>
      <span class="nv">isOneShot: </span><span class="kc">yes</span>
      <span class="nv">oneShotFired: </span><span class="nx">@oneShotFired</span><span class="p">.</span><span class="nx">bind</span> <span class="err">@</span>

  <span class="nv">oneShotFired: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="nv">firings = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">oneShotFired</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="o">!!</span><span class="nx">firings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p><code>$event</code> lets you create an ephemeral event without needing an EventEmitter.
If you already have an EventEmitter object, you should call .event() on it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.event = $event = </span><span class="nf">(callback) -&gt;</span>
  <span class="nv">context = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s1">&#39;_event&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p><code>$eventOneShot</code> lets you create an ephemeral one-shot event without needing an EventEmitter.
If you already have an EventEmitter object, you should call .eventOneShot() on it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.eventOneShot = $eventOneShot = </span><span class="nf">(callback) -&gt;</span>
  <span class="nv">context = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">oneShot = </span><span class="nx">context</span><span class="p">.</span><span class="nx">eventOneShot</span><span class="p">(</span><span class="s1">&#39;_event&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
  <span class="nv">oneShot.oneShotFired = </span><span class="o">-&gt;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">oneShotFired</span><span class="p">(</span><span class="s1">&#39;_event&#39;</span><span class="p">)</span>
  <span class="nx">oneShot</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h2>Objects</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p><code>Batman.initializeObject</code> is called by all the methods in Batman.Object to ensure that the
object's <code>_batman</code> property is initialized and it's own. Classes extending Batman.Object inherit
methods like <code>get</code>, <code>set</code>, and <code>observe</code> by default on the class and prototype levels, such that
both instances and the class respond to them and can be bound to. However, CoffeeScript's static
class inheritance copies over all class level properties indiscriminately, so a parent class'
<code>_batman</code> object will get copied to its subclasses, transferring all the information stored there and
allowing subclasses to mutate parent state. This method prevents this undesirable behaviour by tracking
which object the <code>_batman_</code> object was initialized upon, and reinitializing if that has changed since
initialization.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.initializeObject = </span><span class="nf">(object) -&gt;</span>
  <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span>
    <span class="nx">object</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nv">object._batman = </span><span class="k">new</span> <span class="nx">_Batman</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>_Batman provides a convienient, parent class and prototype aware place to store hidden
object state. Things like observers, accessors, and states belong in the <code>_batman</code> object
attached to every Batman.Object subclass and subclass instance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman._Batman = </span><span class="k">class</span> <span class="nx">_Batman</span>
  <span class="nv">constructor: </span><span class="nf">(@object, mixins...) -&gt;</span>
    <span class="nx">$mixin</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">mixins</span><span class="p">...)</span> <span class="k">if</span> <span class="nx">mixins</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Used by <code>Batman.initializeObject</code> to ensure that this <code>_batman</code> was created referencing
the object it is pointing to.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">check: </span><span class="nf">(object) -&gt;</span>
    <span class="k">if</span> <span class="nx">object</span> <span class="o">!=</span> <span class="nx">@object</span>
      <span class="nv">object._batman = </span><span class="k">new</span> <span class="nx">_Batman</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="k">return</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p><code>get</code> is a prototype and class aware property access method. <code>get</code> will traverse the prototype chain, asking
for the passed key at each step, and then attempting to merge the results into one object.
It can only do this if at each level an <code>Array</code>, <code>Hash</code>, or <code>Set</code> is found, so try to use
those if you need <code>_batman</code> inhertiance.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get: </span><span class="nf">(key) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Get all the keys from the ancestor chain</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">results = </span><span class="nx">@getAll</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">switch</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">when</span> <span class="mi">0</span>
        <span class="kc">undefined</span>
      <span class="k">when</span> <span class="mi">1</span>
        <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>And then try to merge them if there is more than one. Use <code>concat</code> on arrays, and <code>merge</code> on
sets and hashes.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">concat</span><span class="o">?</span>
          <span class="nv">results = </span><span class="nx">results</span><span class="p">.</span><span class="nx">reduceRight</span> <span class="nf">(a, b) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">merge</span><span class="o">?</span>
          <span class="nv">results = </span><span class="nx">results</span><span class="p">.</span><span class="nx">reduceRight</span> <span class="nf">(a, b) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
        <span class="nx">results</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p><code>getFirst</code> is a prototype and class aware property access method. <code>getFirst</code> traverses the prototype chain,
and returns the value of the first <code>_batman</code> object which defines the passed key. Useful for
times when the merged value doesn't make sense or the value is a primitive.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getFirst: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">results = </span><span class="nx">@getAll</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p><code>getAll</code> is a prototype and class chain iterator. When passed a key or function, it applies it to each
parent class or parent prototype, and returns the undefined values, closest ancestor first.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getAll: </span><span class="nf">(keyOrGetter) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Get a function which pulls out the key from the ancestor's <code>_batman</code> or use the passed function.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">keyOrGetter</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nv">getter = </span><span class="nx">keyOrGetter</span>
    <span class="k">else</span>
      <span class="nv">getter = </span><span class="nf">(ancestor) -&gt;</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">[</span><span class="nx">keyOrGetter</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Apply it to all the ancestors, and then this <code>_batman</code>'s object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">results = </span><span class="nx">@ancestors</span><span class="p">(</span><span class="nx">getter</span><span class="p">)</span>
    <span class="k">if</span> <span class="nv">val = </span><span class="nx">getter</span><span class="p">(</span><span class="nx">@object</span><span class="p">)</span>
      <span class="nx">results</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">val</span>
    <span class="nx">results</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p><code>ancestors</code> traverses the prototype or class chain and returns the application of a function to each
object in the chain. <code>ancestors</code> does this <em>only</em> to the <code>@object</code>'s ancestors, and not the <code>@object</code>
itsself.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ancestors: </span><span class="p">(</span><span class="nv">getter = </span><span class="nf">(x) -&gt;</span> <span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">results = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Decide if the object is a class or not, and pull out the first ancestor</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">isClass = </span><span class="o">!!</span><span class="nx">@object</span><span class="p">.</span><span class="nx">prototype</span>
    <span class="nv">parent = </span><span class="k">if</span> <span class="nx">isClass</span>
      <span class="nx">@object</span><span class="p">.</span><span class="nx">__super__</span><span class="o">?</span><span class="p">.</span><span class="nx">constructor</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">proto = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span><span class="nx">@object</span><span class="p">))</span> <span class="o">==</span> <span class="nx">@object</span>
        <span class="nx">@object</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">__super__</span>
      <span class="k">else</span>
        <span class="nx">proto</span>

    <span class="k">if</span> <span class="nx">parent</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Apply the function and store the result if it isn't undefined.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">val = </span><span class="nx">getter</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span>
      <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="k">if</span> <span class="nx">val</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Use a recursive call to <code>_batman.ancestors</code> on the ancestor, which will take the next step up the chain.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">results = </span><span class="nx">results</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">ancestors</span><span class="p">(</span><span class="nx">getter</span><span class="p">))</span> <span class="k">if</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span>
    <span class="nx">results</span>

  <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p><code>Batman.Object</code> is the base class for all other Batman objects. It is not abstract.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">BatmanObject</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Setting <code>isGlobal</code> to true will cause the class name to be defined on the
global object. For example, Batman.Model will be aliased to window.Model.
This should be used sparingly; it's mostly useful for debugging.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@global: </span><span class="nf">(isGlobal) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">isGlobal</span> <span class="o">is</span> <span class="kc">false</span>
    <span class="nx">container</span><span class="p">[</span><span class="nx">@name</span><span class="p">]</span> <span class="o">=</span> <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Apply mixins to this class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@classMixin: </span><span class="o">-&gt;</span> <span class="nx">$mixin</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Apply mixins to instances of this class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@mixin: </span><span class="o">-&gt;</span> <span class="nx">@classMixin</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="nx">arguments</span>
  <span class="nv">mixin: </span><span class="nx">@classMixin</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Accessor implementation. Accessors are used to create properties on a class or prototype which can be fetched
with get, but are computed instead of just stored. This is a batman and old browser friendly version of
<code>defineProperty</code> without as much goodness.</p>

<p>Accessors track which other properties they rely on for computation, and when those other properties change,
an accessor will recalculate its value and notifiy its observers. This way, when a source value is changed,
any dependent accessors will automatically update any bindings to them with a new value. Accessors accomplish
this feat by tracking <code>get</code> calls, do be sure to use <code>get</code> to retrieve properties inside accessors.</p>

<p><code>@accessor</code> or <code>@classAccessor</code> can be called with zero, one, or many keys to attach the accessor to. This
has the following effects:</p>

<ul>
<li>zero: create a <code>defaultAccessor</code>, which will be called when no other properties or accessors on an object
match a keypath. This is similar to <code>method_missing</code> in Ruby or <code>#doesNotUnderstand</code> in Smalltalk.</li>
<li>one: create a <code>keyAccessor</code> at the given key, which will only be called when that key is <code>get</code>ed.</li>
<li>many: create <code>keyAccessors</code> for each given key, which will then be called whenever each key is <code>get</code>ed.</li>
</ul>

<p>Note: This function gets called in all sorts of different contexts by various
other pointers to it, but it acts the same way on <code>this</code> in all cases.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getAccessorObject = </span><span class="nf">(accessor) -&gt;</span>
    <span class="nv">accessor = </span><span class="p">{</span><span class="nv">get: </span><span class="nx">accessor</span><span class="p">}</span> <span class="k">if</span> <span class="o">!</span><span class="nx">accessor</span><span class="p">.</span><span class="nx">get</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">accessor</span><span class="p">.</span><span class="nx">set</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">accessor</span><span class="p">.</span><span class="nx">unset</span>
    <span class="nx">accessor</span>

  <span class="vi">@classAccessor: </span><span class="nf">(keys..., accessor) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Create a default accessor if no keys have been given.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>The <code>accessor</code> argument is wrapped in <code>getAccessorObject</code> which allows functions to be passed in
as a shortcut to {get: function}</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@_batman.defaultAccessor = </span><span class="nx">getAccessorObject</span><span class="p">(</span><span class="nx">accessor</span><span class="p">)</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Otherwise, add key accessors for each key given.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@_batman</span><span class="p">.</span><span class="nx">keyAccessors</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
      <span class="nx">@_batman</span><span class="p">.</span><span class="nx">keyAccessors</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">getAccessorObject</span><span class="p">(</span><span class="nx">accessor</span><span class="p">))</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Support adding accessors to the prototype from within class defintions or after the class has been created
with <code>KlassExtendingBatmanObject.accessor(keys..., accessorObject)</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@accessor: </span><span class="o">-&gt;</span> <span class="nx">@classAccessor</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="nx">arguments</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Support adding accessors to instances after creation</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">accessor: </span><span class="nx">@classAccessor</span>

  <span class="nv">constructor: </span><span class="nf">(mixins...) -&gt;</span>
    <span class="vi">@_batman = </span><span class="k">new</span> <span class="nx">_Batman</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="nx">@mixin</span> <span class="nx">mixins</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Make every subclass and their instances observable.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@classMixin</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">EventEmitter</span>
  <span class="nx">@mixin</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">EventEmitter</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Observe this property on every instance of this class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@observeAll: </span><span class="o">-&gt;</span> <span class="err">@</span><span class="o">::</span><span class="nx">observe</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="nx">arguments</span>

  <span class="vi">@singleton: </span><span class="nf">(singletonMethodName=&quot;sharedInstance&quot;) -&gt;</span>
    <span class="nx">@classAccessor</span> <span class="nx">singletonMethodName</span><span class="p">,</span>
      <span class="nv">get: </span><span class="o">-&gt;</span> <span class="err">@</span><span class="p">[</span><span class="s2">&quot;_#{singletonMethodName}&quot;</span><span class="p">]</span> <span class="o">||=</span> <span class="k">new</span> <span class="err">@</span>

<span class="nv">Batman.Object = </span><span class="nx">BatmanObject</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@_storage = </span><span class="p">{}</span>
    <span class="vi">@length = </span><span class="mi">0</span>
  <span class="nv">hasKey: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">matches = </span><span class="nx">@_storage</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nx">match</span> <span class="k">in</span> <span class="nx">matches</span>
      <span class="k">if</span> <span class="nx">@equality</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">key</span><span class="p">)</span>
        <span class="nv">pair = </span><span class="nx">match</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="k">return</span> <span class="kc">false</span>
  <span class="nv">get: </span><span class="nf">(key) -&gt;</span>
    <span class="k">return</span> <span class="kc">undefined</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
    <span class="k">if</span> <span class="nv">matches = </span><span class="nx">@_storage</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">for</span> <span class="p">[</span><span class="nx">obj</span><span class="p">,</span><span class="nx">v</span><span class="p">]</span> <span class="k">in</span> <span class="nx">matches</span>
        <span class="k">return</span> <span class="nx">v</span> <span class="k">if</span> <span class="nx">@equality</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="nv">set: </span><span class="nf">(key, val) -&gt;</span>
    <span class="k">return</span> <span class="kc">undefined</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
    <span class="nv">matches = </span><span class="nx">@_storage</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nx">match</span> <span class="k">in</span> <span class="nx">matches</span>
      <span class="k">if</span> <span class="nx">@equality</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">key</span><span class="p">)</span>
        <span class="nv">pair = </span><span class="nx">match</span>
        <span class="k">break</span>
    <span class="nx">unless</span> <span class="nx">pair</span>
      <span class="nv">pair = </span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="nx">matches</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pair</span><span class="p">)</span>
      <span class="nx">@length</span><span class="o">++</span>
    <span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
  <span class="nv">unset: </span><span class="nf">(key) -&gt;</span>
    <span class="k">if</span> <span class="nv">matches = </span><span class="nx">@_storage</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">for</span> <span class="p">[</span><span class="nx">obj</span><span class="p">,</span><span class="nx">v</span><span class="p">],</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">matches</span>
        <span class="k">if</span> <span class="nx">@equality</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
          <span class="nx">matches</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="nx">@length</span><span class="o">--</span>
          <span class="k">return</span>
  <span class="nv">equality: </span><span class="nf">(lhs, rhs) -&gt;</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">lhs</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">or</span> <span class="k">typeof</span> <span class="nx">rhs</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">lhs</span><span class="p">.</span><span class="nx">isEqual</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nx">lhs</span><span class="p">.</span><span class="nx">isEqual</span> <span class="nx">rhs</span>
    <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">rhs</span><span class="p">.</span><span class="nx">isEqual</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nx">rhs</span><span class="p">.</span><span class="nx">isEqual</span> <span class="nx">lhs</span>
    <span class="k">else</span>
      <span class="nx">lhs</span> <span class="o">is</span> <span class="nx">rhs</span>
  <span class="nv">forEach: </span><span class="nf">(iterator) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">values</span> <span class="k">of</span> <span class="nx">@_storage</span>
      <span class="nx">iterator</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="k">for</span> <span class="p">[</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">]</span> <span class="k">in</span> <span class="nx">values</span>
  <span class="nv">keys: </span><span class="o">-&gt;</span>
    <span class="nv">result = </span><span class="p">[]</span>
    <span class="nx">@forEach</span> <span class="nf">(obj) -&gt;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span>
    <span class="nx">result</span>
  <span class="nv">clear: </span><span class="o">-&gt;</span>
    <span class="vi">@_storage = </span><span class="p">{}</span>
    <span class="vi">@length = </span><span class="mi">0</span>
  <span class="nv">isEmpty: </span><span class="o">-&gt;</span>
    <span class="nx">@length</span> <span class="o">is</span> <span class="mi">0</span>
  <span class="nv">merge: </span><span class="nf">(others...) -&gt;</span>
    <span class="nv">merged = </span><span class="k">new</span> <span class="nx">@constructor</span>
    <span class="nx">others</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">hash</span> <span class="k">in</span> <span class="nx">others</span>
      <span class="nx">hash</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(obj, value) -&gt;</span>
        <span class="nx">merged</span><span class="p">.</span><span class="nx">set</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span>
    <span class="nx">merged</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Hash</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
    <span class="k">super</span>

  <span class="nx">@accessor</span>
    <span class="nv">get: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">get</span>
    <span class="nv">set: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">set</span>
    <span class="nv">unset: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">unset</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@isEmpty</span><span class="p">()</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;hasKey&#39;</span><span class="p">,</span> <span class="s1">&#39;equality&#39;</span><span class="p">,</span> <span class="s1">&#39;forEach&#39;</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="s1">&#39;merge&#39;</span><span class="p">,</span> <span class="s1">&#39;clear&#39;</span><span class="p">]</span>
    <span class="err">@</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@_storage = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="vi">@length = </span><span class="mi">0</span>
    <span class="nx">@add</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span> <span class="k">if</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="nv">has: </span><span class="nf">(item) -&gt;</span>
    <span class="nx">@_storage</span><span class="p">.</span><span class="nx">hasKey</span> <span class="nx">item</span>
  <span class="nv">add: </span><span class="nf">(items...) -&gt;</span>
    <span class="nv">addedItems = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span>
      <span class="nx">unless</span> <span class="nx">@_storage</span><span class="p">.</span><span class="nx">hasKey</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
        <span class="nx">@_storage</span><span class="p">.</span><span class="nx">set</span> <span class="nx">item</span><span class="p">,</span> <span class="kc">true</span>
        <span class="nx">addedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span>
        <span class="nx">@length</span><span class="o">++</span>
    <span class="nx">@itemsWereAdded</span><span class="p">(</span><span class="nx">addedItems</span><span class="p">...)</span> <span class="nx">unless</span> <span class="nx">addedItems</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="nx">addedItems</span>
  <span class="nv">remove: </span><span class="nf">(items...) -&gt;</span>
    <span class="nv">removedItems = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span>
      <span class="k">if</span> <span class="nx">@_storage</span><span class="p">.</span><span class="nx">hasKey</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
        <span class="nx">@_storage</span><span class="p">.</span><span class="nx">unset</span> <span class="nx">item</span>
        <span class="nx">removedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span>
        <span class="nx">@length</span><span class="o">--</span>
    <span class="nx">@itemsWereRemoved</span><span class="p">(</span><span class="nx">removedItems</span><span class="p">...)</span> <span class="nx">unless</span> <span class="nx">removedItems</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="nx">removedItems</span>
  <span class="nv">forEach: </span><span class="nf">(iterator) -&gt;</span>
    <span class="nx">@_storage</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(key, value) -&gt;</span> <span class="nx">iterator</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="nv">isEmpty: </span><span class="o">-&gt;</span> <span class="nx">@length</span> <span class="o">is</span> <span class="mi">0</span>
  <span class="nv">clear: </span><span class="o">-&gt;</span>
    <span class="nv">items = </span><span class="nx">@toArray</span><span class="p">()</span>
    <span class="vi">@_storage = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="vi">@length = </span><span class="mi">0</span>
    <span class="nx">@itemsWereRemoved</span><span class="p">(</span><span class="nx">items</span><span class="p">)</span>
    <span class="nx">items</span>
  <span class="nv">toArray: </span><span class="o">-&gt;</span>
    <span class="nx">@_storage</span><span class="p">.</span><span class="nx">keys</span><span class="p">()</span>

  <span class="nv">merge: </span><span class="nf">(others...) -&gt;</span>
    <span class="nv">merged = </span><span class="k">new</span> <span class="nx">@constructor</span>
    <span class="nx">others</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">set</span> <span class="k">in</span> <span class="nx">others</span>
      <span class="nx">set</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(v) -&gt;</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">add</span> <span class="nx">v</span>
    <span class="nx">merged</span>
  <span class="nv">itemsWereAdded: </span><span class="o">-&gt;</span>
  <span class="nv">itemsWereRemoved: </span><span class="o">-&gt;</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
  <span class="nv">itemsWereAdded: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
  <span class="nv">itemsWereRemoved: </span><span class="nx">@event</span> <span class="o">-&gt;</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="s1">&#39;forEach&#39;</span><span class="p">,</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="s1">&#39;toArray&#39;</span><span class="p">]</span>
    <span class="err">@</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="s1">&#39;clear&#39;</span><span class="p">,</span> <span class="s1">&#39;merge&#39;</span><span class="p">]</span>
    <span class="nx">do</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="err">@</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
        <span class="nv">oldLength = </span><span class="nx">@length</span>
        <span class="nv">results = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
        <span class="nx">@property</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">).</span><span class="nx">fireDependents</span><span class="p">()</span>
        <span class="nx">results</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@isEmpty</span><span class="p">()</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@length</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SortableSet</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span>
    <span class="vi">@_indexes = </span><span class="p">{}</span>
    <span class="nx">@observe</span> <span class="s1">&#39;activeIndex&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="nx">@setWasSorted</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
  <span class="nv">setWasSorted: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">@length</span> <span class="o">is</span> <span class="mi">0</span>
  <span class="nv">add: </span><span class="o">-&gt;</span>
    <span class="nv">results = </span><span class="k">super</span>
    <span class="nx">@_reIndex</span><span class="p">()</span>
    <span class="nx">results</span>
  <span class="nv">remove: </span><span class="o">-&gt;</span>
    <span class="nv">results = </span><span class="k">super</span>
    <span class="nx">@_reIndex</span><span class="p">()</span>
    <span class="nx">results</span>
  <span class="nv">addIndex: </span><span class="nf">(index) -&gt;</span>
    <span class="nx">@_reIndex</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>
  <span class="nv">removeIndex: </span><span class="nf">(index) -&gt;</span>
    <span class="nx">@_indexes</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="k">delete</span> <span class="nx">@_indexes</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
    <span class="nx">@unset</span><span class="p">(</span><span class="s1">&#39;activeIndex&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@activeIndex</span> <span class="o">is</span> <span class="nx">index</span>
    <span class="nx">index</span>
  <span class="nv">forEach: </span><span class="nf">(iterator) -&gt;</span>
    <span class="nx">iterator</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="k">for</span> <span class="nx">el</span> <span class="k">in</span> <span class="nx">@toArray</span><span class="p">()</span>
  <span class="nv">sortBy: </span><span class="nf">(index) -&gt;</span>
    <span class="nx">@addIndex</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">@_indexes</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
    <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;activeIndex&#39;</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">@activeIndex</span> <span class="o">is</span> <span class="nx">index</span>
    <span class="err">@</span>
  <span class="nv">isSorted: </span><span class="o">-&gt;</span>
    <span class="nx">@_indexes</span><span class="p">[</span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;activeIndex&#39;</span><span class="p">)]</span><span class="o">?</span>
  <span class="nv">toArray: </span><span class="o">-&gt;</span>
    <span class="nx">@_indexes</span><span class="p">[</span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;activeIndex&#39;</span><span class="p">)]</span> <span class="o">||</span> <span class="k">super</span>
  <span class="nv">_reIndex: </span><span class="nf">(index) -&gt;</span>
    <span class="k">if</span> <span class="nx">index</span>
      <span class="p">[</span><span class="nx">keypath</span><span class="p">,</span> <span class="nx">ordering</span><span class="p">]</span> <span class="o">=</span> <span class="nx">index</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39; &#39;</span>
      <span class="nv">ary = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toArray</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
      <span class="nx">@_indexes</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ary</span><span class="p">.</span><span class="nx">sort</span> <span class="nf">(a,b) -&gt;</span>
        <span class="nv">valueA = </span><span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">property</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">keypath</span><span class="p">)).</span><span class="nx">getValue</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">()</span>
        <span class="nv">valueB = </span><span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">property</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">keypath</span><span class="p">)).</span><span class="nx">getValue</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">()</span>
        <span class="p">[</span><span class="nx">valueA</span><span class="p">,</span> <span class="nx">valueB</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">valueB</span><span class="p">,</span> <span class="nx">valueA</span><span class="p">]</span> <span class="k">if</span> <span class="nx">ordering</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;desc&#39;</span>
        <span class="k">if</span> <span class="nx">valueA</span> <span class="o">&lt;</span> <span class="nx">valueB</span> <span class="k">then</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">valueA</span> <span class="o">&gt;</span> <span class="nx">valueB</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
      <span class="nx">@setWasSorted</span><span class="p">(</span><span class="err">@</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@activeIndex</span> <span class="o">is</span> <span class="nx">index</span>
    <span class="k">else</span>
      <span class="nx">@_reIndex</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="k">for</span> <span class="nx">index</span> <span class="k">of</span> <span class="nx">@_indexes</span>
      <span class="nx">@setWasSorted</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <h2>State Machines</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.StateMachine = </span><span class="p">{</span>
  <span class="nv">initialize: </span><span class="o">-&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">states</span>
      <span class="vi">@_batman.states = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
      <span class="nx">@accessor</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span>
        <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@state</span><span class="p">()</span>
        <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span> <span class="nx">_stateMachine_setState</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>

  <span class="nv">state: </span><span class="nf">(name, callback) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">name</span>
      <span class="k">return</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">getFirst</span> <span class="s1">&#39;state&#39;</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">@event</span>
      <span class="k">throw</span> <span class="s2">&quot;StateMachine requires EventEmitter&quot;</span>

    <span class="nv">event = </span><span class="err">@</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">||</span> <span class="nx">@event</span> <span class="nx">name</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">_stateMachine_setState</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span> <span class="kc">false</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">callback</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="nx">event</span>

  <span class="nv">transition: </span><span class="nf">(from, to, callback) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>

    <span class="nx">@state</span> <span class="nx">from</span>
    <span class="nx">@state</span> <span class="nx">to</span>

    <span class="nv">name = </span><span class="s2">&quot;#{from}-&gt;#{to}&quot;</span>
    <span class="nv">transitions = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">states</span>

    <span class="nv">event = </span><span class="nx">transitions</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">||</span> <span class="nx">transitions</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">$event</span> <span class="o">-&gt;</span><span class="p">)</span>
    <span class="nx">event</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="k">if</span> <span class="nx">callback</span>
    <span class="nx">event</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>A special method to alias state machine methods to class methods</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.Object.actsAsStateMachine = </span><span class="nf">(includeInstanceMethods=true) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@prototype</span>

    <span class="vi">@classState = </span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="vi">@state = </span><span class="o">-&gt;</span> <span class="nx">@classState</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="err">@</span><span class="o">::</span><span class="nv">state = </span><span class="nx">@classState</span> <span class="k">if</span> <span class="nx">includeInstanceMethods</span>

    <span class="vi">@classTransition = </span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">transition</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="vi">@transition = </span><span class="o">-&gt;</span> <span class="nx">@classTransition</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="err">@</span><span class="o">::</span><span class="nv">transition = </span><span class="nx">@classTransition</span> <span class="k">if</span> <span class="nx">includeInstanceMethods</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>This is cached here so it doesn't need to be recompiled for every setter</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_stateMachine_setState = </span><span class="nf">(newState) -&gt;</span>
  <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>

  <span class="k">if</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">isTransitioning</span>
    <span class="p">(</span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">nextState</span> <span class="o">||=</span> <span class="p">[]).</span><span class="nx">push</span><span class="p">(</span><span class="nx">newState</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">false</span>

  <span class="vi">@_batman.isTransitioning = </span><span class="kc">yes</span>

  <span class="nv">oldState = </span><span class="nx">@state</span><span class="p">()</span>
  <span class="vi">@_batman.state = </span><span class="nx">newState</span>

  <span class="k">if</span> <span class="nx">newState</span> <span class="o">and</span> <span class="nx">oldState</span>
    <span class="nv">name = </span><span class="s2">&quot;#{oldState}-&gt;#{newState}&quot;</span>
    <span class="k">for</span> <span class="nx">event</span> <span class="k">in</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">getAll</span><span class="p">(</span><span class="nf">(ancestor) -&gt;</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;states&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
      <span class="k">if</span> <span class="nx">event</span>
        <span class="nx">event</span> <span class="nx">newState</span><span class="p">,</span> <span class="nx">oldState</span>

  <span class="k">if</span> <span class="nx">newState</span>
    <span class="nx">@fire</span> <span class="nx">newState</span><span class="p">,</span> <span class="nx">newState</span><span class="p">,</span> <span class="nx">oldState</span>

  <span class="vi">@_batman.isTransitioning = </span><span class="kc">no</span>
  <span class="err">@</span><span class="p">[</span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">nextState</span><span class="p">.</span><span class="nx">shift</span><span class="p">()]()</span> <span class="k">if</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">nextState</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>

  <span class="nx">newState</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <h2>App, Requests, and Routing</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p><code>Batman.Request</code> is a normalizer for XHR requests in the Batman world.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">url: </span><span class="s1">&#39;&#39;</span>
  <span class="nv">data: </span><span class="s1">&#39;&#39;</span>
  <span class="nv">method: </span><span class="s1">&#39;get&#39;</span>
  <span class="nv">response: </span><span class="kc">null</span>
  <span class="nv">contentType: </span><span class="s1">&#39;application/json&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>After the URL gets set, we'll try to automatically send
your request after a short period. If this behavior is
not desired, use @cancel() after setting the URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@observeAll</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="vi">@_autosendTimeout = </span><span class="nx">setTimeout</span> <span class="p">(</span><span class="o">=&gt;</span> <span class="nx">@send</span><span class="p">()),</span> <span class="mi">0</span>

  <span class="nv">loading: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
  <span class="nv">loaded: </span><span class="nx">@event</span> <span class="o">-&gt;</span>

  <span class="nv">success: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
  <span class="nv">error: </span><span class="nx">@event</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p><code>send</code> is implmented in the platform layer files. One of those must be required for
<code>Batman.Request</code> to be useful.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">send: </span><span class="nf">() -&gt;</span> <span class="k">throw</span> <span class="s2">&quot;Please source a dependency file for a request implementation&quot;</span>

  <span class="nv">cancel: </span><span class="o">-&gt;</span>
    <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">@_autosendTimeout</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@_autosendTimeout</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p><code>Batman.App</code> manages requiring files and acts as a namespace for all code subclassing
Batman objects.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">App</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Require path tells the require methods which base directory to look in.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@requirePath: </span><span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>The require class methods (<code>controller</code>, <code>model</code>, <code>view</code>) simply tells
your app where to look for coffeescript source files. This
implementation may change in the future.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@require: </span><span class="nf">(path, names...) -&gt;</span>
    <span class="nv">base = </span><span class="nx">@requirePath</span> <span class="o">+</span> <span class="nx">path</span>
    <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">names</span>
      <span class="nx">@prevent</span> <span class="s1">&#39;run&#39;</span>

      <span class="nv">path = </span><span class="nx">base</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;.coffee&#39;</span> <span class="c1"># FIXME: don&#39;t hardcode this</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span>
        <span class="nv">url: </span><span class="nx">path</span>
        <span class="nv">type: </span><span class="s1">&#39;html&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">CoffeeScript</span><span class="p">.</span><span class="nb">eval</span> <span class="nx">response</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>FIXME: under no circumstances should we be compiling coffee in
the browser. This can be fixed via a real deployment solution
to compile coffeescripts, such as Sprockets.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">@allow</span> <span class="s1">&#39;run&#39;</span>
          <span class="nx">@run</span><span class="p">()</span> <span class="c1"># FIXME: this should only happen if the client actually called run.</span>
    <span class="err">@</span>

  <span class="vi">@controller: </span><span class="nf">(names...) -&gt;</span>
    <span class="nv">names = </span><span class="nx">names</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(n) -&gt;</span> <span class="nx">n</span> <span class="o">+</span> <span class="s1">&#39;_controller&#39;</span>
    <span class="nx">@require</span> <span class="s1">&#39;controllers&#39;</span><span class="p">,</span> <span class="nx">names</span><span class="p">...</span>

  <span class="vi">@model: </span><span class="o">-&gt;</span>
    <span class="nx">@require</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span>

  <span class="vi">@view: </span><span class="o">-&gt;</span>
    <span class="nx">@require</span> <span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Layout is the base view that other views can be yielded into. The
default behavior is that when <code>app.run()</code> is called, a new view will
be created for the layout using the <code>document</code> node as its content.
Use <code>MyApp.layout = null</code> to turn off the default behavior.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@layout: </span><span class="kc">undefined</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Call <code>MyApp.run()</code> to start up an app. Batman level initializers will
be run to bootstrap the application.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@run: </span><span class="nx">@eventOneShot</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span> <span class="o">is</span> <span class="err">@</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>

    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">@hasRun</span>
    <span class="nv">Batman.currentApp = </span><span class="err">@</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@dispatcher</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="nx">@dispatcher</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Dispatcher</span> <span class="err">@</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@layout</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="nx">@set</span> <span class="s1">&#39;layout&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span>
        <span class="nv">contexts: </span><span class="p">[</span><span class="err">@</span><span class="p">]</span>
        <span class="nv">node: </span><span class="nb">document</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@historyManager</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">and</span> <span class="nx">@dispatcher</span><span class="p">.</span><span class="nx">routeMap</span>
      <span class="vi">@historyManager = </span><span class="nv">Batman.historyManager = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">HashHistory</span> <span class="err">@</span>
      <span class="nx">@historyManager</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

    <span class="vi">@hasRun = </span><span class="kc">yes</span>
    <span class="err">@</span>

  <span class="vi">@stop: </span><span class="nx">@eventOneShot</span> <span class="o">-&gt;</span>
    <span class="nx">@historyManager</span><span class="o">?</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
    <span class="nv">Batman.historyManager = </span><span class="kc">null</span>
    <span class="vi">@hasRun = </span><span class="kc">no</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <h2>Dispatcher</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Route</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Route regexes courtesy of Backbone</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">namedParam = </span><span class="sr">/:([\w\d]+)/g</span>
  <span class="nv">splatParam = </span><span class="sr">/\*([\w\d]+)/g</span>
  <span class="nv">queryParam = </span><span class="s1">&#39;(?:\\?.+)?&#39;</span>
  <span class="nv">namedOrSplat = </span><span class="sr">/[:|\*]([\w\d]+)/g</span>
  <span class="nv">escapeRegExp = </span><span class="sr">/[-[\]{}()+?.,\\^$|#\s]/g</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span>

    <span class="vi">@pattern = </span><span class="nx">@url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">escapeRegExp</span><span class="p">,</span> <span class="s1">&#39;\\$&amp;&#39;</span><span class="p">)</span>
    <span class="vi">@regexp = </span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">@pattern</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">namedParam</span><span class="p">,</span> <span class="s1">&#39;([^\/]*)&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">splatParam</span><span class="p">,</span> <span class="s1">&#39;(.*?)&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">queryParam</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">)</span>

    <span class="vi">@namedArguments = </span><span class="p">[]</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">array = </span><span class="nx">namedOrSplat</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">@pattern</span><span class="p">))</span><span class="o">?</span>
      <span class="nx">@namedArguments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nx">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span>
      <span class="k">return</span> <span class="nx">@action</span> <span class="k">if</span> <span class="nx">@action</span>

      <span class="k">if</span> <span class="nx">@options</span>
        <span class="nv">result = </span><span class="nx">$mixin</span> <span class="p">{},</span> <span class="nx">@options</span>

        <span class="k">if</span> <span class="nv">signature = </span><span class="nx">result</span><span class="p">.</span><span class="nx">signature</span>
          <span class="nv">components = </span><span class="nx">signature</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
          <span class="nv">result.controller = </span><span class="nx">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="nv">result.action = </span><span class="nx">components</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;index&#39;</span>

        <span class="nv">result.target = </span><span class="nx">@dispatcher</span><span class="p">.</span><span class="nx">get</span> <span class="nx">result</span><span class="p">.</span><span class="nx">controller</span>
        <span class="nx">@set</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="nx">result</span>
    <span class="nv">set: </span><span class="nf">(key, action) -&gt;</span>
      <span class="vi">@action = </span><span class="nx">action</span>

  <span class="nv">parameterize: </span><span class="nf">(url) -&gt;</span>
    <span class="p">[</span><span class="nx">url</span><span class="p">,</span> <span class="nx">query</span><span class="p">]</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;?&#39;</span>
    <span class="nv">array = </span><span class="nx">@regexp</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">params = url: </span><span class="nx">url</span>

    <span class="nv">action = </span><span class="nx">@get</span> <span class="s1">&#39;action&#39;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">action</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nv">params.action = </span><span class="nx">action</span>
    <span class="k">else</span>
      <span class="nx">$mixin</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">action</span>

    <span class="k">if</span> <span class="nx">array</span>
      <span class="k">for</span> <span class="nx">param</span><span class="p">,</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">array</span>
        <span class="nx">params</span><span class="p">[</span><span class="nx">@namedArguments</span><span class="p">[</span><span class="nx">index</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">param</span>

    <span class="k">if</span> <span class="nx">query</span>
      <span class="k">for</span> <span class="nx">s</span> <span class="k">in</span> <span class="nx">query</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;&amp;&#39;</span>
        <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;=&#39;</span>
        <span class="nx">params</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="nx">params</span>

  <span class="nv">dispatch: </span><span class="nf">(url) -&gt;</span>
    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;String&#39;</span>
      <span class="nv">params = </span><span class="nx">@parameterize</span> <span class="nx">url</span>

    <span class="nx">$redirect</span><span class="p">(</span><span class="s1">&#39;/404&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nv">action = </span><span class="nx">params</span><span class="p">.</span><span class="nx">action</span><span class="p">)</span> <span class="o">and</span> <span class="nx">url</span> <span class="o">isnt</span> <span class="s1">&#39;/404&#39;</span>
    <span class="k">return</span> <span class="nx">action</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">action</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="k">return</span> <span class="nx">params</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="k">if</span> <span class="nx">params</span><span class="p">.</span><span class="nx">target</span><span class="o">?</span><span class="p">.</span><span class="nx">dispatch</span>
    <span class="k">return</span> <span class="nx">params</span><span class="p">.</span><span class="nx">target</span><span class="o">?</span><span class="p">[</span><span class="nx">action</span><span class="p">](</span><span class="nx">params</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Dispatcher</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nf">(@app) -&gt;</span>
    <span class="nx">@app</span><span class="p">.</span><span class="nx">route</span> <span class="err">@</span>

    <span class="vi">@app.controllers = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">controller</span> <span class="k">of</span> <span class="nx">@app</span>
      <span class="k">continue</span> <span class="nx">unless</span> <span class="nx">controller</span><span class="o">?</span><span class="p">.</span><span class="nx">prototype</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Controller</span>
      <span class="nx">@prepareController</span> <span class="nx">controller</span>

  <span class="nv">prepareController: </span><span class="nf">(controller) -&gt;</span>
    <span class="nv">name = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;Controller&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">name</span>

    <span class="nv">getter = </span><span class="o">-&gt;</span> <span class="err">@</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;sharedController&#39;</span>
    <span class="nx">@accessor</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">getter</span>
    <span class="nx">@app</span><span class="p">.</span><span class="nx">controllers</span><span class="p">.</span><span class="nx">accessor</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">getter</span>

  <span class="nv">register: </span><span class="nf">(url, options) -&gt;</span>
    <span class="nv">url = </span><span class="s2">&quot;/#{url}&quot;</span> <span class="k">if</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="mi">0</span>
    <span class="nv">route = </span><span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;Function&#39;</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Route</span> <span class="nv">url: </span><span class="nx">url</span><span class="p">,</span> <span class="nv">action: </span><span class="nx">options</span><span class="p">,</span> <span class="nv">dispatcher: </span><span class="err">@</span>
    <span class="k">else</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Route</span> <span class="nv">url: </span><span class="nx">url</span><span class="p">,</span> <span class="nv">options: </span><span class="nx">options</span><span class="p">,</span> <span class="nv">dispatcher: </span><span class="err">@</span>

    <span class="nx">@routeMap</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="nx">@routeMap</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="nx">route</span>

  <span class="nv">findRoute: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">url = </span><span class="s2">&quot;/#{url}&quot;</span> <span class="k">if</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nx">route</span> <span class="k">if</span> <span class="p">(</span><span class="nv">route = </span><span class="nx">@routeMap</span><span class="p">[</span><span class="nx">url</span><span class="p">])</span>
    <span class="k">for</span> <span class="nx">routeUrl</span><span class="p">,</span> <span class="nx">route</span> <span class="k">of</span> <span class="nx">@routeMap</span>
      <span class="k">return</span> <span class="nx">route</span> <span class="k">if</span> <span class="nx">route</span><span class="p">.</span><span class="nx">regexp</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>

  <span class="nv">findUrl: </span><span class="nf">(params) -&gt;</span>
    <span class="k">for</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">route</span> <span class="k">of</span> <span class="nx">@routeMap</span>
      <span class="nv">matches = </span><span class="kc">no</span>
      <span class="k">if</span> <span class="nx">params</span><span class="p">.</span><span class="nx">resource</span>
        <span class="k">if</span> <span class="nx">route</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">resource</span> <span class="o">is</span> <span class="nx">params</span><span class="p">.</span><span class="nx">resource</span>
          <span class="nv">matches = </span><span class="kc">yes</span>
      <span class="k">else</span>
        <span class="nv">action = </span><span class="nx">route</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;action&#39;</span>
        <span class="k">continue</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">action</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>

        <span class="p">{</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">action</span><span class="p">}</span> <span class="o">=</span> <span class="nx">action</span>
        <span class="k">if</span> <span class="nx">controller</span> <span class="o">is</span> <span class="nx">params</span><span class="p">.</span><span class="nx">controller</span> <span class="o">and</span> <span class="nx">action</span> <span class="o">is</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">action</span> <span class="o">||</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>
          <span class="nv">matches = </span><span class="kc">yes</span>

      <span class="k">continue</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">matches</span>
      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">params</span>
        <span class="nv">url = </span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;[:|\*]&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">),</span> <span class="nx">value</span>

      <span class="k">return</span> <span class="nx">url</span>

  <span class="nv">dispatch: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">route = </span><span class="nx">@findRoute</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">route</span>
      <span class="nx">route</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">url</span> <span class="o">isnt</span> <span class="s1">&#39;/404&#39;</span>
      <span class="nx">$redirect</span><span class="p">(</span><span class="s1">&#39;/404&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <h2>History Manager</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">HistoryManager</span>
  <span class="nv">constructor: </span><span class="nf">(@app) -&gt;</span>
  <span class="nv">dispatch: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">url = </span><span class="s2">&quot;/#{url}&quot;</span> <span class="k">if</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="mi">0</span>
    <span class="nx">@app</span><span class="p">.</span><span class="nx">dispatcher</span><span class="p">.</span><span class="nx">dispatch</span> <span class="nx">url</span>

    <span class="nx">url</span>
  <span class="nv">redirect: </span><span class="nf">(url) -&gt;</span>
    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">isnt</span> <span class="s1">&#39;String&#39;</span>
      <span class="nv">url = </span><span class="nx">@app</span><span class="p">.</span><span class="nx">dispatcher</span><span class="p">.</span><span class="nx">findUrl</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="nx">@dispatch</span> <span class="nx">url</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">HashHistory</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">HistoryManager</span>
  <span class="nv">HASH_PREFIX: </span><span class="s1">&#39;#!&#39;</span>

  <span class="nv">start: </span><span class="o">=&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@started</span>
    <span class="vi">@started = </span><span class="kc">yes</span>

    <span class="k">if</span> <span class="s1">&#39;onhashchange&#39;</span> <span class="k">of</span> <span class="nb">window</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s1">&#39;hashchange&#39;</span><span class="p">,</span> <span class="nx">@parseHash</span><span class="p">,</span> <span class="kc">false</span>
    <span class="k">else</span>
      <span class="vi">@interval = </span><span class="nx">setInterval</span> <span class="nx">@parseHash</span><span class="p">,</span> <span class="mi">100</span>

    <span class="nx">setTimeout</span> <span class="nx">@parseHash</span><span class="p">,</span> <span class="mi">0</span>

  <span class="nv">stop: </span><span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@interval</span>
      <span class="vi">@interval = </span><span class="nx">clearInterval</span> <span class="nx">@interval</span>
    <span class="k">else</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span> <span class="s1">&#39;hashchange&#39;</span><span class="p">,</span> <span class="nx">@parseHash</span><span class="p">,</span> <span class="kc">false</span>

    <span class="vi">@started = </span><span class="kc">no</span>

  <span class="nv">urlFor: </span><span class="nf">(url) -&gt;</span>
    <span class="nx">@HASH_PREFIX</span> <span class="o">+</span> <span class="nx">url</span>

  <span class="nv">parseHash: </span><span class="o">=&gt;</span>
    <span class="nv">hash = </span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">@HASH_PREFIX</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">hash</span> <span class="o">is</span> <span class="nx">@cachedHash</span>

    <span class="nx">@dispatch</span> <span class="p">(</span><span class="vi">@cachedHash = </span><span class="nx">hash</span><span class="p">)</span>

  <span class="nv">redirect: </span><span class="nf">(params) -&gt;</span>
    <span class="nv">url = </span><span class="k">super</span>
    <span class="vi">@cachedHash = </span><span class="nx">url</span>

    <span class="nb">window</span><span class="p">.</span><span class="nv">location.hash = </span><span class="nx">@HASH_PREFIX</span> <span class="o">+</span> <span class="nx">url</span>

<span class="nv">Batman.redirect = $redirect = </span><span class="nf">(url) -&gt;</span>
  <span class="nx">Batman</span><span class="p">.</span><span class="nx">historyManager</span><span class="o">?</span><span class="p">.</span><span class="nx">redirect</span> <span class="nx">url</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <h2>Route Declarators</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Batman</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">classMixin</span>
  <span class="nv">route: </span><span class="nf">(url, signature, options={}) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">url</span>
    <span class="k">if</span> <span class="nx">url</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Dispatcher</span>
      <span class="nv">dispatcher = </span><span class="nx">url</span>
      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@_dispatcherCache</span>
        <span class="nx">dispatcher</span><span class="p">.</span><span class="nx">register</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>

      <span class="vi">@_dispatcherCache = </span><span class="kc">null</span>
      <span class="k">return</span> <span class="nx">dispatcher</span>

    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">signature</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;String&#39;</span>
      <span class="nv">options.signature = </span><span class="nx">signature</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">signature</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;Function&#39;</span>
      <span class="nv">options = </span><span class="nx">signature</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">signature</span>
      <span class="nx">$mixin</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">signature</span>

    <span class="nx">@_dispatcherCache</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="nx">@_dispatcherCache</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span>

  <span class="nv">root: </span><span class="nf">(signature, options) -&gt;</span>
    <span class="nx">@route</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">signature</span><span class="p">,</span> <span class="nx">options</span>

  <span class="nv">resources: </span><span class="nf">(resource, options, callback) -&gt;</span>
    <span class="p">(</span><span class="nv">callback = </span><span class="nx">options</span><span class="p">;</span> <span class="nv">options = </span><span class="kc">null</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">options</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="nv">controller = </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">controller</span> <span class="o">||</span> <span class="nx">resource</span>

    <span class="nx">@route</span><span class="p">(</span><span class="nx">resource</span><span class="p">,</span> <span class="s2">&quot;#{controller}#index&quot;</span><span class="p">).</span><span class="nv">resource = </span><span class="nx">controller</span>
    <span class="nx">@route</span><span class="p">(</span><span class="s2">&quot;#{resource}/:id&quot;</span><span class="p">,</span> <span class="s2">&quot;#{controller}#show&quot;</span><span class="p">).</span><span class="nv">resource = </span><span class="nx">controller</span>
    <span class="nx">@route</span><span class="p">(</span><span class="s2">&quot;#{resource}/:id/edit&quot;</span><span class="p">,</span> <span class="s2">&quot;#{controller}#edit&quot;</span><span class="p">).</span><span class="nv">resource = </span><span class="nx">controller</span>
    <span class="nx">@route</span><span class="p">(</span><span class="s2">&quot;#{resource}/:id/destroy&quot;</span><span class="p">,</span> <span class="s2">&quot;#{controller}#destroy&quot;</span><span class="p">).</span><span class="nv">resource = </span><span class="nx">controller</span>

    <span class="k">if</span> <span class="nx">callback</span>
      <span class="nv">app = </span><span class="err">@</span>
      <span class="nv">ops =</span>
        <span class="nv">collection: </span><span class="nf">(collectionCallback) -&gt;</span>
          <span class="nx">collectionCallback</span><span class="o">?</span><span class="p">.</span><span class="nx">call</span> <span class="nv">route: </span><span class="nf">(url, methodName) -&gt;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">route</span> <span class="s2">&quot;#{resource}/#{url}&quot;</span><span class="p">,</span> <span class="s2">&quot;#{controller}##{methodName || url}&quot;</span>
        <span class="nv">member: </span><span class="nf">(memberCallback) -&gt;</span>
          <span class="nx">memberCallback</span><span class="o">?</span><span class="p">.</span><span class="nx">call</span> <span class="nv">route: </span><span class="nf">(url, methodName) -&gt;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">route</span> <span class="s2">&quot;#{resource}/:id/#{url}&quot;</span><span class="p">,</span> <span class="s2">&quot;#{controller}##{methodName || url}&quot;</span>

      <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span> <span class="nx">ops</span>

  <span class="nv">redirect: </span><span class="nx">$redirect</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <h2>Controllers</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Controller</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nx">@singleton</span> <span class="s1">&#39;sharedController&#39;</span>

  <span class="vi">@beforeFilter: </span><span class="nf">(nameOrFunction) -&gt;</span>
    <span class="nv">filters = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">beforeFilters</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="nx">filters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">nameOrFunction</span><span class="p">)</span> <span class="k">if</span> <span class="o">~</span><span class="nx">filters</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">nameOrFunction</span><span class="p">)</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;controllerName&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@_controllerName</span> <span class="o">||=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;Controller&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@_currentAction</span>
    <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span> <span class="vi">@_currentAction = </span><span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>You shouldn't call this method directly. It will be called by the dispatcher when a route is called.
If you need to call a route manually, use <code>$redirect()</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">dispatch: </span><span class="nf">(action, params = {}) -&gt;</span>
    <span class="nx">params</span><span class="p">.</span><span class="nx">controller</span> <span class="o">||=</span> <span class="nx">@get</span> <span class="s1">&#39;controllerName&#39;</span>
    <span class="nx">params</span><span class="p">.</span><span class="nx">action</span> <span class="o">||=</span> <span class="nx">action</span>
    <span class="nx">params</span><span class="p">.</span><span class="nx">target</span> <span class="o">||=</span> <span class="err">@</span>

    <span class="nv">oldRedirect = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">historyManager</span><span class="o">?</span><span class="p">.</span><span class="nx">redirect</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">historyManager</span><span class="o">?</span><span class="p">.</span><span class="nv">redirect = </span><span class="nx">@redirect</span>

    <span class="vi">@_actedDuringAction = </span><span class="kc">no</span>
    <span class="nx">@set</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="nx">action</span>

    <span class="k">if</span> <span class="nv">filters = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">beforeFilters</span>
      <span class="nx">filter</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span> <span class="k">for</span> <span class="nx">filter</span> <span class="k">in</span> <span class="nx">filters</span>

    <span class="nv">result = </span><span class="err">@</span><span class="p">[</span><span class="nx">action</span><span class="p">](</span><span class="nx">params</span><span class="p">)</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">@_actedDuringAction</span> <span class="o">and</span> <span class="nx">result</span> <span class="o">isnt</span> <span class="kc">false</span>
      <span class="nx">@render</span><span class="p">()</span>

    <span class="k">if</span> <span class="nv">filters = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">afterFilters</span>
      <span class="nx">filter</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span> <span class="k">for</span> <span class="nx">filter</span> <span class="k">in</span> <span class="nx">filters</span>

    <span class="k">delete</span> <span class="nx">@_actedDuringAction</span>
    <span class="nx">@set</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="kc">null</span>

    <span class="nx">Batman</span><span class="p">.</span><span class="nx">historyManager</span><span class="o">?</span><span class="p">.</span><span class="nv">redirect = </span><span class="nx">oldRedirect</span>

    <span class="nx">$redirect</span><span class="p">(</span><span class="nx">@_afterFilterRedirect</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@_afterFilterRedirect</span>
    <span class="k">delete</span> <span class="nx">@_afterFilterRedirect</span>

  <span class="nv">redirect: </span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">throw</span> <span class="s1">&#39;DoubleRedirectError&#39;</span> <span class="k">if</span> <span class="nx">@_actedDuringAction</span>
    <span class="k">if</span> <span class="nx">@get</span> <span class="s1">&#39;action&#39;</span>
      <span class="vi">@_actedDuringAction = </span><span class="kc">yes</span>
      <span class="vi">@_afterFilterRedirect = </span><span class="nx">url</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;Object&#39;</span>
        <span class="nv">url.controller = </span><span class="err">@</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">url</span><span class="p">.</span><span class="nx">controller</span>

      <span class="nx">$redirect</span> <span class="nx">url</span>

  <span class="nv">render: </span><span class="nf">(options = {}) -&gt;</span>
    <span class="k">throw</span> <span class="s1">&#39;DoubleRenderError&#39;</span> <span class="k">if</span> <span class="nx">@_actedDuringAction</span>
    <span class="vi">@_actedDuringAction = </span><span class="kc">yes</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">view</span>
      <span class="nv">options.source = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;Controller&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">@_currentAction</span> <span class="o">+</span> <span class="s1">&#39;.html&#39;</span>
      <span class="nv">options.view = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>

    <span class="k">if</span> <span class="nv">view = </span><span class="nx">options</span><span class="p">.</span><span class="nx">view</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">context</span> <span class="o">||=</span> <span class="err">@</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">ready</span> <span class="o">-&gt;</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">contentFor</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <h2>Models</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Model</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <h2>Model API</h2>

<p>Override this property if your model is indexed by a key other than <code>id</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@primaryKey: </span><span class="s1">&#39;id&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Pick one or many mechanisms with which this model should be persisted. The mechanisms
can be already instantiated or just the class defining them.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@persist: </span><span class="nf">(mechanisms...) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="nx">@prototype</span>
    <span class="nv">storage = </span><span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">storage</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nx">mechanism</span> <span class="k">in</span> <span class="nx">mechanisms</span>
      <span class="nx">storage</span><span class="p">.</span><span class="nx">push</span> <span class="k">if</span> <span class="nx">mechanism</span><span class="p">.</span><span class="nx">isStorageAdapter</span> <span class="k">then</span> <span class="nx">mechanism</span> <span class="k">else</span> <span class="k">new</span> <span class="nx">mechanism</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Encoders are the tiny bits of logic which manage marshalling Batman models to and from their
storage representations. Encoders do things like stringifying dates and parsing them back out again,
pulling out nested model collections and instantiating them (and JSON.stringifying them back again),
and marshalling otherwise un-storable object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@encode: </span><span class="nf">(keys..., encoderOrLastKey) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="nx">@prototype</span>
    <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">encoders</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">decoders</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>

    <span class="k">switch</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">encoderOrLastKey</span><span class="p">)</span>
      <span class="k">when</span> <span class="s1">&#39;String&#39;</span>
        <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span> <span class="nx">encoderOrLastKey</span>
      <span class="k">when</span> <span class="s1">&#39;Function&#39;</span>
        <span class="nv">encoder = </span><span class="nx">encoderOrLastKey</span>
      <span class="k">else</span>
        <span class="nv">encoder = </span><span class="nx">encoderOrLastKey</span><span class="p">.</span><span class="nx">encode</span>
        <span class="nv">decoder = </span><span class="nx">encoderOrLastKey</span><span class="p">.</span><span class="nx">decode</span>

    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span>
      <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">encoders</span><span class="p">.</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="p">(</span><span class="nx">encoder</span> <span class="o">||</span> <span class="nx">@defaultEncoder</span><span class="p">)</span>
      <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">decoders</span><span class="p">.</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="p">(</span><span class="nx">decoder</span> <span class="o">||</span> <span class="nx">@defaultDecoder</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Set up the unit functions as the default for both</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@defaultEncoder = @defaultDecoder = </span><span class="nf">(x) -&gt;</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Validations allow a model to be marked as 'valid' or 'invalid' based on a set of programmatic rules.
By validating our data before it gets to the server we can provide immediate feedback to the user about
what they have entered and forgo waiting on a round trip to the server.
<code>validate</code> allows the attachment of validations to the model on particular keys, where the validation is
either a built in one (by use of options to pass to them) or a custom one (by use of a custom function as
the second argument). Custom validators should have the signature <code>(errors, record, key, callback)</code>. They
should add strings to the <code>errors</code> set based on the record (maybe depending on the <code>key</code> they were attached
to) and then always call the callback. Again: the callback must always be called.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@validate: </span><span class="nf">(keys..., optionsOrFunction) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="nx">@prototype</span>
    <span class="nv">validators = </span><span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">validators</span> <span class="o">||=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">optionsOrFunction</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Given a function, use that as the actual validator, expecting it to conform to the API
the built in validators do.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">validators</span><span class="p">.</span><span class="nx">push</span>
        <span class="nv">keys: </span><span class="nx">keys</span>
        <span class="nv">callback: </span><span class="nx">optionsOrFunction</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Given options, find the validations which match the given options, and add them to the validators
array.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">options = </span><span class="nx">optionsOrFunction</span>
      <span class="k">for</span> <span class="nx">validator</span> <span class="k">in</span> <span class="nx">Validators</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">matches = </span><span class="nx">validator</span><span class="p">.</span><span class="nx">matches</span><span class="p">(</span><span class="nx">options</span><span class="p">))</span>
          <span class="k">delete</span> <span class="nx">options</span><span class="p">[</span><span class="nx">match</span><span class="p">]</span> <span class="k">for</span> <span class="nx">match</span> <span class="k">in</span> <span class="nx">matches</span>
          <span class="nx">validators</span><span class="p">.</span><span class="nx">push</span>
            <span class="nv">keys: </span><span class="nx">keys</span>
            <span class="nv">validator: </span><span class="k">new</span> <span class="nx">validator</span><span class="p">(</span><span class="nx">matches</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <h3>Query methods</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@classAccessor</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span>
      <span class="nx">unless</span> <span class="nx">@all</span>
        <span class="vi">@all = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SortableSet</span>
        <span class="nx">@all</span><span class="p">.</span><span class="nx">sortBy</span> <span class="s2">&quot;id asc&quot;</span>
      <span class="nx">@all</span>

    <span class="nv">set: </span><span class="nf">(k,v)-&gt;</span> <span class="vi">@all = </span><span class="nx">v</span>

  <span class="nx">@classAccessor</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">).</span><span class="nx">toArray</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nx">@classAccessor</span> <span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nv">x = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span> <span class="nx">x</span><span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

  <span class="vi">@find: </span><span class="nf">(id, callback) -&gt;</span>
    <span class="nv">record = </span><span class="k">new</span> <span class="err">@</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="nv">newRecord = </span><span class="nx">@_mapIdentities</span><span class="p">([</span><span class="nx">record</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">newRecord</span><span class="p">.</span><span class="nx">load</span> <span class="nx">callback</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p><code>load</code> fetches records from all sources possible</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@load: </span><span class="nf">(options, callback) -&gt;</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">callback</span>
      <span class="nv">callback = </span><span class="nx">options</span>
      <span class="nv">options = </span><span class="p">{}</span>

    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t load model #{@name} without any storage adapters!&quot;</span><span class="p">)</span> <span class="nx">unless</span> <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">getAll</span><span class="p">(</span><span class="s1">&#39;storage&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="nx">do</span> <span class="nx">@loading</span>
    <span class="err">@</span><span class="o">::</span><span class="nx">_doStorageOperation</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">records</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
        <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="p">[])</span>
      <span class="k">else</span>
        <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">@_mapIdentities</span><span class="p">(</span><span class="nx">records</span><span class="p">))</span>
        <span class="nx">do</span> <span class="nx">@loaded</span>

  <span class="vi">@_mapIdentities: </span><span class="nf">(records) -&gt;</span>
    <span class="nv">all = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">).</span><span class="nx">toArray</span><span class="p">()</span>
    <span class="nv">newRecords = </span><span class="p">[]</span>
    <span class="nv">returnRecords = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">record</span> <span class="k">in</span> <span class="nx">records</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">record</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="p">(</span><span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span> <span class="nx">id</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
        <span class="nx">returnRecords</span><span class="p">.</span><span class="nx">push</span> <span class="nx">record</span>
      <span class="k">else</span>
        <span class="nv">existingRecord = </span><span class="kc">false</span>
        <span class="k">for</span> <span class="nx">potential</span> <span class="k">in</span> <span class="nx">all</span>
          <span class="k">if</span> <span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nx">potential</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="nv">existingRecord = </span><span class="nx">potential</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="nx">existingRecord</span>
          <span class="nx">returnRecords</span><span class="p">.</span><span class="nx">push</span> <span class="nx">existingRecord</span>
        <span class="k">else</span>
          <span class="nx">newRecords</span><span class="p">.</span><span class="nx">push</span> <span class="nx">record</span>
          <span class="nx">returnRecords</span><span class="p">.</span><span class="nx">push</span> <span class="nx">record</span>
    <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">newRecords</span><span class="p">...)</span> <span class="k">if</span> <span class="nx">newRecords</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="nx">returnRecords</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <h3>Record API</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span>
      <span class="nv">pk = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;primaryKey&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">pk</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span>
        <span class="nx">@id</span>
      <span class="k">else</span>
        <span class="nx">@get</span><span class="p">(</span><span class="nx">pk</span><span class="p">)</span>
    <span class="nv">set: </span><span class="nf">(k, v) -&gt;</span>
      <span class="nv">pk = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;primaryKey&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">pk</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span>
        <span class="vi">@id = </span><span class="nx">v</span>
      <span class="k">else</span>
        <span class="nx">@set</span><span class="p">(</span><span class="nx">pk</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>New records can be constructed by passing either an ID or a hash of attributes (potentially
containing an ID) to the Model constructor. By not passing an ID, the model is marked as new.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(idOrAttributes = {}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>We have to do this ahead of super, because mixins will call set which calls things on dirtyKeys.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@dirtyKeys = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Hash</span>
    <span class="vi">@errors = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ErrorsHash</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Find the ID from either the first argument or the attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">idOrAttributes</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;Object&#39;</span>
      <span class="k">super</span><span class="p">(</span><span class="nx">idOrAttributes</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">super</span><span class="p">()</span>
      <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">idOrAttributes</span><span class="p">)</span>

    <span class="nx">@empty</span><span class="p">()</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@state</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Override the <code>Batman.Observable</code> implementation of <code>set</code> to implement dirty tracking.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Optimize setting where the value is the same as what's already been set.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">oldValue = </span><span class="nx">@get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">oldValue</span> <span class="o">is</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Actually set the value and note what the old value was in the tracking array.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">result = </span><span class="k">super</span>
    <span class="nx">@dirtyKeys</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Mark the model as dirty if isn't already.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@dirty</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">@state</span><span class="p">()</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;dirty&#39;</span><span class="p">,</span> <span class="s1">&#39;loading&#39;</span><span class="p">,</span> <span class="s1">&#39;creating&#39;</span><span class="p">]</span>
    <span class="nx">result</span>

  <span class="nv">toString: </span><span class="o">-&gt;</span>
    <span class="s2">&quot;#{@constructor.name}: #{@get(&#39;id&#39;)}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p><code>toJSON</code> uses the various encoders for each key to grab a storable representation of the record.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">toJSON: </span><span class="o">-&gt;</span>
    <span class="nv">obj = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Encode each key into a new object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">encoders = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;encoders&#39;</span><span class="p">)</span>
    <span class="nx">unless</span> <span class="o">!</span><span class="nx">encoders</span> <span class="o">or</span> <span class="nx">encoders</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
      <span class="nx">encoders</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">encoder</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">val = </span><span class="nx">@get</span> <span class="nx">key</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">val</span> <span class="o">isnt</span> <span class="s1">&#39;undefined&#39;</span>
          <span class="nv">encodedVal = </span><span class="nx">encoder</span><span class="p">(</span><span class="nx">@get</span> <span class="nx">key</span><span class="p">)</span>
          <span class="k">if</span> <span class="k">typeof</span> <span class="nx">encodedVal</span> <span class="o">isnt</span> <span class="s1">&#39;undefined&#39;</span>
            <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">encodedVal</span>

    <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p><code>fromJSON</code> uses the various decoders for each key to generate a record instance from the JSON
stored in whichever storage mechanism.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fromJSON: </span><span class="nf">(data) -&gt;</span>
    <span class="nv">obj = </span><span class="p">{}</span>
    <span class="nv">decoders = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;decoders&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>If no decoders were specified, do the best we can to interpret the given JSON by camelizing
each key and just setting the values.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">!</span><span class="nx">decoders</span> <span class="o">or</span> <span class="nx">decoders</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">data</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">camelize</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="kc">yes</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>If we do have decoders, use them to get the data.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">decoders</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(key, decoder) -&gt;</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">decoder</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Mixin the buffer object to use optimized and event-preventing sets used by <code>mixin</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@mixin</span> <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Each model instance (each record) can be in one of many states throughout its lifetime. Since various
operations on the model are asynchronous, these states are used to indicate exactly what point the
record is at in it's lifetime, which can often be during a save or load operation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@actsAsStateMachine</span> <span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Add the various states to the model.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;dirty&#39;</span><span class="p">,</span> <span class="s1">&#39;loading&#39;</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="s1">&#39;saving&#39;</span><span class="p">,</span> <span class="s1">&#39;saved&#39;</span><span class="p">,</span> <span class="s1">&#39;creating&#39;</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;validating&#39;</span><span class="p">,</span> <span class="s1">&#39;validated&#39;</span><span class="p">,</span> <span class="s1">&#39;destroying&#39;</span><span class="p">,</span> <span class="s1">&#39;destroyed&#39;</span><span class="p">]</span>
    <span class="nx">@state</span> <span class="nx">k</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;loading&#39;</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">]</span>
    <span class="nx">@classState</span> <span class="nx">k</span>

  <span class="nv">_doStorageOperation: </span><span class="nf">(operation, options, callback) -&gt;</span>
    <span class="nv">mechanisms = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;storage&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t #{operation} model #{@constructor.name} without any storage adapters!&quot;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">mechanisms</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="nx">mechanism</span> <span class="k">in</span> <span class="nx">mechanisms</span>
      <span class="nx">mechanism</span><span class="p">[</span><span class="nx">operation</span><span class="p">]</span> <span class="err">@</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span>
    <span class="kc">true</span>

  <span class="nv">_hasStorage: </span><span class="o">-&gt;</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">getAll</span><span class="p">(</span><span class="s1">&#39;storage&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p><code>load</code> fetches the record from all sources possible</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">load: </span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;destroying&#39;</span><span class="p">,</span> <span class="s1">&#39;destroyed&#39;</span><span class="p">]</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t save a destroyed record!&quot;</span><span class="p">))</span>
      <span class="k">return</span>

    <span class="nx">do</span> <span class="nx">@loading</span>
    <span class="nx">@_doStorageOperation</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">do</span> <span class="nx">@loaded</span> <span class="nx">unless</span> <span class="nx">err</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">_mapIdentities</span><span class="p">([</span><span class="nx">record</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p><code>save</code> persists a record to all the storage mechanisms added using <code>@persist</code>. <code>save</code> will only save
a model if it is valid.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">save: </span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;destroying&#39;</span><span class="p">,</span> <span class="s1">&#39;destroyed&#39;</span><span class="p">]</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t save a destroyed record!&quot;</span><span class="p">))</span>
      <span class="k">return</span>
    <span class="nx">@validate</span> <span class="p">(</span><span class="nx">isValid</span><span class="p">,</span> <span class="nx">errors</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="o">!</span><span class="nx">isValid</span>
        <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">errors</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="nv">creating = </span><span class="nx">@isNew</span><span class="p">()</span>

      <span class="nx">do</span> <span class="nx">@saving</span>
      <span class="nx">do</span> <span class="nx">@creating</span> <span class="k">if</span> <span class="nx">creating</span>
      <span class="nx">@_doStorageOperation</span> <span class="p">(</span><span class="k">if</span> <span class="nx">creating</span> <span class="k">then</span> <span class="s1">&#39;create&#39;</span> <span class="k">else</span> <span class="s1">&#39;update&#39;</span><span class="p">),</span> <span class="p">{},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">unless</span> <span class="nx">err</span>
          <span class="k">if</span> <span class="nx">creating</span>
            <span class="nx">do</span> <span class="nx">@created</span>
          <span class="nx">do</span> <span class="nx">@saved</span>
          <span class="nx">@dirtyKeys</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
        <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">_mapIdentities</span><span class="p">([</span><span class="nx">record</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p><code>destroy</code> destroys a record in all the stores.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">destroy: </span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">do</span> <span class="nx">@destroying</span>
    <span class="nx">@_doStorageOperation</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">unless</span> <span class="nx">err</span>
        <span class="nx">@constructor</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
        <span class="nx">do</span> <span class="nx">@destroyed</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p><code>validate</code> performs the record level validations determining the record's validity. These may be asynchronous,
in which case <code>validate</code> has no useful return value. Results from asynchronous validations can be received by
listening to the <code>afterValidation</code> lifecycle callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">validate: </span><span class="nf">(callback) -&gt;</span>
    <span class="nv">oldState = </span><span class="nx">@state</span><span class="p">()</span>
    <span class="nx">@errors</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
    <span class="nx">do</span> <span class="nx">@validating</span>

    <span class="nv">finish = </span><span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">do</span> <span class="nx">@validated</span>
      <span class="err">@</span><span class="p">[</span><span class="nx">oldState</span><span class="p">]()</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">@errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@errors</span><span class="p">)</span>

    <span class="nv">validators = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;validators&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]</span>
    <span class="nx">unless</span> <span class="nx">validators</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">finish</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nv">count = </span><span class="nx">validators</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">validationCallback = </span><span class="o">=&gt;</span>
        <span class="k">if</span> <span class="o">--</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="nx">finish</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">validator</span> <span class="k">in</span> <span class="nx">validators</span>
        <span class="nv">v = </span><span class="nx">validator</span><span class="p">.</span><span class="nx">validator</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Run the validator <code>v</code> or the custom callback on each key it validates by instantiating a new promise
and passing it to the appropriate function along with the key and the value to be validated.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">validator</span><span class="p">.</span><span class="nx">keys</span>
          <span class="k">if</span> <span class="nx">v</span>
            <span class="nx">v</span><span class="p">.</span><span class="nx">validateEach</span> <span class="nx">@errors</span><span class="p">,</span> <span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">validationCallback</span>
          <span class="k">else</span>
            <span class="nx">validator</span><span class="p">.</span><span class="nx">callback</span> <span class="nx">@errors</span><span class="p">,</span> <span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">validationCallback</span>
    <span class="k">return</span>

  <span class="nv">isNew: </span><span class="o">-&gt;</span> <span class="k">typeof</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p><code>ErrorHash</code> is a simple subclass of <code>Hash</code> which makes it a bit easier to
manage the errors on a model.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ErrorsHash</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Hash</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span> <span class="k">super</span><span class="p">(</span><span class="nv">_sets: </span><span class="p">{})</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Define a default accessor to instantiate a set for any requested key.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span>
    <span class="nv">get: </span><span class="nf">(key) -&gt;</span>
      <span class="nx">unless</span> <span class="nx">@_sets</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="nx">@_sets</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span>
        <span class="nx">@length</span><span class="o">++</span>
      <span class="nx">@_sets</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nv">set: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">defaultAccessor</span><span class="p">.</span><span class="nx">set</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Define a shorthand method for adding errors to a key.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">add: </span><span class="nf">(key, error) -&gt;</span> <span class="nx">@get</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
  <span class="nv">clear: </span><span class="o">-&gt;</span>
    <span class="vi">@_sets = </span><span class="p">{}</span>
    <span class="k">super</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Validator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nf">(@options, mixins...) -&gt;</span>
    <span class="k">super</span> <span class="nx">mixins</span><span class="p">...</span>

  <span class="nv">validate: </span><span class="nf">(record) -&gt;</span>
    <span class="k">throw</span> <span class="s2">&quot;You must override validate in Batman.Validator subclasses.&quot;</span>

  <span class="vi">@options: </span><span class="nf">(options...) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="k">if</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">options</span> <span class="k">then</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="k">else</span> <span class="vi">@_batman.options = </span><span class="nx">options</span>

  <span class="vi">@matches: </span><span class="nf">(options) -&gt;</span>
    <span class="nv">results = </span><span class="p">{}</span>
    <span class="nv">shouldReturn = </span><span class="kc">no</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">options</span>
      <span class="k">if</span> <span class="o">~</span><span class="nx">@_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
        <span class="nx">results</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
        <span class="nv">shouldReturn = </span><span class="kc">yes</span>
    <span class="k">return</span> <span class="nx">results</span> <span class="k">if</span> <span class="nx">shouldReturn</span>

<span class="nv">Validators = Batman.Validators = </span><span class="p">[</span>
  <span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">LengthValidator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Validator</span>
    <span class="nx">@options</span> <span class="s1">&#39;minLength&#39;</span><span class="p">,</span> <span class="s1">&#39;maxLength&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;lengthWithin&#39;</span><span class="p">,</span> <span class="s1">&#39;lengthIn&#39;</span>
    <span class="nv">constructor: </span><span class="nf">(options) -&gt;</span>
      <span class="k">if</span> <span class="nv">range = </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lengthIn</span> <span class="o">or</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lengthWithin</span><span class="p">)</span>
        <span class="nv">options.minLength = </span><span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">options.maxLength = </span><span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lengthWithin</span>
        <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lengthIn</span>

      <span class="k">super</span>

    <span class="nv">validateEach: </span><span class="nf">(errors, record, key, callback) -&gt;</span>
      <span class="nv">options = </span><span class="nx">@options</span>
      <span class="nv">value = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">minLength</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">minLength</span>
        <span class="nx">errors</span><span class="p">.</span><span class="nx">add</span> <span class="nx">key</span><span class="p">,</span> <span class="s2">&quot;#{key} must be at least #{options.minLength} characters&quot;</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">maxLength</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">maxLength</span>
        <span class="nx">errors</span><span class="p">.</span><span class="nx">add</span> <span class="nx">key</span><span class="p">,</span> <span class="s2">&quot;#{key} must be less than #{options.maxLength} characters&quot;</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">options</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">errors</span><span class="p">.</span><span class="nx">add</span> <span class="nx">key</span><span class="p">,</span> <span class="s2">&quot;#{key} must be #{options.length} characters&quot;</span>
      <span class="nx">callback</span><span class="p">()</span>

  <span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">PresenceValidator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Validator</span>
    <span class="nx">@options</span> <span class="s1">&#39;presence&#39;</span>
    <span class="nv">validateEach: </span><span class="nf">(errors, record, key, callback) -&gt;</span>
      <span class="nv">value = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">presence</span> <span class="o">and</span> <span class="o">!</span><span class="nx">value</span><span class="o">?</span>
        <span class="nx">errors</span><span class="p">.</span><span class="nx">add</span> <span class="nx">key</span><span class="p">,</span> <span class="s2">&quot;#{key} must be present&quot;</span>
      <span class="nx">callback</span><span class="p">()</span>
<span class="p">]</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StorageAdapter</span>
  <span class="nv">constructor: </span><span class="nf">(@model) -&gt;</span>
    <span class="vi">@modelKey = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span>
  <span class="nv">isStorageAdapter: </span><span class="kc">true</span>
  <span class="nv">getRecordsFromData: </span><span class="nf">(datas) -&gt;</span>
    <span class="nv">datas = </span><span class="nx">@transformCollectionData</span><span class="p">(</span><span class="nx">datas</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@transformCollectionData</span><span class="o">?</span>
    <span class="k">for</span> <span class="nx">data</span> <span class="k">in</span> <span class="nx">datas</span>
       <span class="nx">@getRecordFromData</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="nv">getRecordFromData: </span><span class="nf">(data) -&gt;</span>
    <span class="nv">data = </span><span class="nx">@transformRecordData</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@transformRecordData</span><span class="o">?</span>
    <span class="nv">record = </span><span class="k">new</span> <span class="nx">@model</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">LocalStorage</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StorageAdapter</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="k">return</span> <span class="kc">null</span>
    <span class="k">super</span>
    <span class="vi">@storage = </span><span class="nx">localStorage</span>
    <span class="vi">@key_re = </span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;^#{@modelKey}(\\d+)$&quot;</span><span class="p">)</span>
    <span class="vi">@nextId = </span><span class="mi">1</span>
    <span class="nx">@_forAllRecords</span> <span class="nf">(k, v) -&gt;</span>
      <span class="k">if</span> <span class="nv">matches = </span><span class="nx">@key_re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
        <span class="vi">@nextId = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">@nextId</span><span class="p">,</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span>

  <span class="nv">_forAllRecords: </span><span class="nf">(f) -&gt;</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@storage</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
      <span class="nv">k = </span><span class="nx">@storage</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
      <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">@storage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span>

  <span class="nv">getRecordFromData: </span><span class="nf">(data) -&gt;</span>
    <span class="nv">record = </span><span class="k">super</span>
    <span class="vi">@nextId = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">@nextId</span><span class="p">,</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">record</span>

  <span class="nv">update: </span><span class="nf">(record, options, callback) -&gt;</span>
    <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">id</span><span class="o">?</span>
      <span class="nx">@storage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">@modelKey</span> <span class="o">+</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">record</span><span class="p">))</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get record primary key.&quot;</span><span class="p">))</span>

  <span class="nv">create: </span><span class="nf">(record, options, callback) -&gt;</span>
    <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">record</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">@nextId</span><span class="o">++</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">id</span><span class="o">?</span>
      <span class="nv">key = </span><span class="nx">@modelKey</span> <span class="o">+</span> <span class="nx">id</span>
      <span class="k">if</span> <span class="nx">@storage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
        <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t create because the record already exists!&quot;</span><span class="p">))</span>
      <span class="k">else</span>
        <span class="nx">@storage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">record</span><span class="p">))</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t set record primary key on create!&quot;</span><span class="p">))</span>

  <span class="nv">read: </span><span class="nf">(record, options, callback) -&gt;</span>
    <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">id</span><span class="o">?</span>
      <span class="nv">attrs = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">@storage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">@modelKey</span> <span class="o">+</span> <span class="nx">id</span><span class="p">))</span>
      <span class="k">if</span> <span class="nx">attrs</span>
        <span class="nx">record</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find record!&quot;</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get record primary key.&quot;</span><span class="p">))</span>

  <span class="nv">readAll: </span><span class="nf">(_, options, callback) -&gt;</span>
    <span class="nv">records = </span><span class="p">[]</span>
    <span class="nx">@_forAllRecords</span> <span class="nf">(storageKey, data) -&gt;</span>
      <span class="k">if</span> <span class="nv">keyMatches = </span><span class="nx">@key_re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">storageKey</span><span class="p">)</span>
        <span class="nv">match = </span><span class="kc">true</span>
        <span class="nv">data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">@model</span><span class="p">.</span><span class="nx">primaryKey</span><span class="p">]</span> <span class="o">||=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">keyMatches</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">options</span>
          <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">v</span>
            <span class="nv">match = </span><span class="kc">false</span>
            <span class="k">break</span>
        <span class="nx">records</span><span class="p">.</span><span class="nx">push</span> <span class="nx">data</span> <span class="k">if</span> <span class="nx">match</span>

    <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">@getRecordsFromData</span><span class="p">(</span><span class="nx">records</span><span class="p">))</span>

  <span class="nv">destroy: </span><span class="nf">(record, options, callback) -&gt;</span>
    <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">id</span><span class="o">?</span>
      <span class="nv">key = </span><span class="nx">@modelKey</span> <span class="o">+</span> <span class="nx">id</span>
      <span class="k">if</span> <span class="nx">@storage</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">key</span>
        <span class="nx">@storage</span><span class="p">.</span><span class="nx">removeItem</span> <span class="nx">key</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t delete nonexistant record!&quot;</span><span class="p">),</span> <span class="nx">record</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t delete record without an primary key!&quot;</span><span class="p">),</span> <span class="nx">record</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">RestStorage</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StorageAdapter</span>
  <span class="nv">defaultOptions:</span>
    <span class="nv">type: </span><span class="s1">&#39;json&#39;</span>
  <span class="nv">recordJsonNamespace: </span><span class="kc">false</span>
  <span class="nv">collectionJsonNamespace: </span><span class="kc">false</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span>
    <span class="vi">@recordJsonNamespace = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">singularize</span><span class="p">(</span><span class="nx">@modelKey</span><span class="p">)</span>
    <span class="vi">@collectionJsonNamespace = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">@modelKey</span><span class="p">)</span>
    <span class="nx">@model</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
  <span class="nv">transformRecordData: </span><span class="nf">(data) -&gt;</span>
    <span class="k">return</span> <span class="nx">data</span><span class="p">[</span><span class="nx">@recordJsonNamespace</span><span class="p">]</span> <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">@recordJsonNamespace</span><span class="p">]</span>
    <span class="nx">data</span>
  <span class="nv">transformCollectionData: </span><span class="nf">(data) -&gt;</span>
    <span class="k">return</span> <span class="nx">data</span><span class="p">[</span><span class="nx">@collectionJsonNamespace</span><span class="p">]</span> <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">@collectionJsonNamespace</span><span class="p">]</span>
    <span class="nx">data</span>
  <span class="nv">optionsForRecord: </span><span class="nf">(record, idRequired, callback) -&gt;</span>
    <span class="k">if</span> <span class="nx">record</span><span class="p">.</span><span class="nx">url</span>
      <span class="nv">url = </span><span class="k">if</span> <span class="k">typeof</span> <span class="nx">record</span><span class="p">.</span><span class="nx">url</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="nx">record</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span> <span class="k">else</span> <span class="nx">record</span><span class="p">.</span><span class="nx">url</span>
    <span class="k">else</span>
      <span class="nv">url = </span><span class="s2">&quot;/#{@modelKey}&quot;</span>
      <span class="k">if</span> <span class="nx">idRequired</span> <span class="o">||</span> <span class="o">!</span><span class="nx">record</span><span class="p">.</span><span class="nx">isNew</span><span class="p">()</span>
        <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">id</span><span class="o">?</span>
          <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get record primary key!&quot;</span><span class="p">))</span>
          <span class="k">return</span>
        <span class="nv">url = </span><span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">id</span>
    <span class="nx">unless</span> <span class="nx">url</span>
      <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get model url!&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">$mixin</span> <span class="p">{},</span> <span class="nx">@defaultOptions</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="p">,</span> <span class="nv">data: </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">record</span><span class="p">)}</span>

  <span class="nv">optionsForCollection: </span><span class="nf">(recordsOptions, callback) -&gt;</span>
    <span class="nv">url = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">url</span><span class="o">?</span><span class="p">()</span> <span class="o">||</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">url</span> <span class="o">||</span> <span class="s2">&quot;/#{@modelKey}&quot;</span>
    <span class="nx">unless</span> <span class="nx">url</span>
      <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get collection url!&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">$mixin</span> <span class="p">{},</span> <span class="nx">@defaultOptions</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="p">,</span> <span class="nv">data: </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">recordsOptions</span><span class="p">)}</span>

  <span class="nv">create: </span><span class="nf">(record, recordOptions, callback) -&gt;</span>
    <span class="nx">@optionsForRecord</span> <span class="nx">record</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nf">(err, options) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>

      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="nx">$mixin</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nv">method: </span><span class="s1">&#39;POST&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">record</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">@transformRecordData</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span>
        <span class="nv">error: </span><span class="nf">(err) -&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>

  <span class="nv">update: </span><span class="nf">(record, recordOptions, callback) -&gt;</span>
    <span class="nx">@optionsForRecord</span> <span class="nx">record</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nf">(err, options) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>

      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="nx">$mixin</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nv">method: </span><span class="s1">&#39;PUT&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">record</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">@transformRecordData</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span>
        <span class="nv">error: </span><span class="nf">(err) -&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>

  <span class="nv">read: </span><span class="nf">(record, recordOptions, callback) -&gt;</span>
    <span class="nx">@optionsForRecord</span> <span class="nx">record</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nf">(err, options) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>

      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="nx">$mixin</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nv">method: </span><span class="s1">&#39;GET&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">record</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">@transformRecordData</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span>
        <span class="nv">error: </span><span class="nf">(err) -&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>

  <span class="nv">readAll: </span><span class="nf">(_, recordsOptions, callback) -&gt;</span>
    <span class="nx">@optionsForCollection</span> <span class="nx">recordsOptions</span><span class="p">,</span> <span class="nf">(err, options) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="nx">$mixin</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nv">method: </span><span class="s1">&#39;GET&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">@getRecordsFromData</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
        <span class="nv">error: </span><span class="nf">(err) -&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>

  <span class="nv">destroy: </span><span class="nf">(record, optiosn, callback) -&gt;</span>
    <span class="nx">@optionsForRecord</span> <span class="nx">record</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nf">(err, options) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="nx">$mixin</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nv">method: </span><span class="s1">&#39;DELETE&#39;</span>
        <span class="nv">success: </span><span class="o">-&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span>
        <span class="nv">error: </span><span class="nf">(err) -&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <h2>Views</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>A <code>Batman.View</code> can function two ways: a mechanism to load and/or parse html files
or a root of a subclass hierarchy to create rich UI classes, like in Cocoa.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">viewSources = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>Set the source attribute to an html file to have that file loaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">source: </span><span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>Set the html to a string of html to have that html parsed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">html: </span><span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Set an existing DOM node to parse immediately.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">node: </span><span class="kc">null</span>

  <span class="nv">context: </span><span class="kc">null</span>
  <span class="nv">contexts: </span><span class="kc">null</span>
  <span class="nv">contentFor: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>Fires once a node is parsed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ready: </span><span class="nx">@eventOneShot</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>Where to look for views on the server</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">prefix: </span><span class="s1">&#39;views&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>Whenever the source changes we load it up asynchronously</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@observeAll</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">=&gt;</span> <span class="nx">@reloadSource</span><span class="p">()),</span> <span class="mi">0</span>

  <span class="nv">reloadSource: </span><span class="o">-&gt;</span>
    <span class="nv">source = </span><span class="nx">@get</span> <span class="s1">&#39;source&#39;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">source</span>

    <span class="k">if</span> <span class="nx">viewSources</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span>
      <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="nx">viewSources</span><span class="p">[</span><span class="nx">source</span><span class="p">])</span>
    <span class="k">else</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span>
        <span class="nv">url: </span><span class="s2">&quot;views/#{@source}&quot;</span>
        <span class="nv">type: </span><span class="s1">&#39;html&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">viewSources</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span> <span class="o">=</span> <span class="nx">response</span>
          <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
        <span class="nv">error: </span><span class="nf">(response) -&gt;</span>
          <span class="k">throw</span> <span class="s2">&quot;Could not load view from #{url}&quot;</span>

  <span class="nx">@observeAll</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="nf">(html) -&gt;</span>
    <span class="nv">node = </span><span class="nx">@node</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s1">&#39;div&#39;</span>
    <span class="nv">node.innerHTML = </span><span class="nx">html</span>

    <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@node</span> <span class="o">isnt</span> <span class="nx">node</span>

  <span class="nx">@observeAll</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="nf">(node) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">node</span>
    <span class="vi">@ready.fired = </span><span class="kc">false</span>

    <span class="k">if</span> <span class="nx">@_renderer</span>
      <span class="nx">@_renderer</span><span class="p">.</span><span class="nx">forgetAll</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>We use a renderer with the continuation style rendering engine to not
block user interaction for too long during the render.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">node</span>
      <span class="vi">@_renderer = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Renderer</span><span class="p">(</span> <span class="nx">node</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="nv">content = </span><span class="nx">@contentFor</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">content</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
          <span class="vi">@contentFor = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yields</span><span class="o">?</span><span class="p">[</span><span class="nx">content</span><span class="p">]</span>

        <span class="k">if</span> <span class="nx">@contentFor</span> <span class="o">and</span> <span class="nx">node</span>
          <span class="vi">@contentFor.innerHTML = </span><span class="s1">&#39;&#39;</span>
          <span class="nx">@contentFor</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">@contexts</span><span class="p">)</span>

      <span class="nx">@_renderer</span><span class="p">.</span><span class="nx">rendered</span> <span class="o">=&gt;</span>
        <span class="nx">@ready</span> <span class="nx">node</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Ensure any context object explicitly given for use in rendering the view (in <code>@context</code>) gets passed to the renderer</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@_renderer</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@context</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@context</span>
      <span class="nx">@_renderer</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <h2>DOM Helpers</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p><code>Batman.Renderer</code> will take a node and parse all recognized data attributes out of it and its children.
It is a continuation style parser, designed not to block for longer than 50ms at a time if the document
fragment is particularly long.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Renderer</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>

  <span class="nv">constructor: </span><span class="nf">(@node, @callback, contexts = []) -&gt;</span>
    <span class="k">super</span>
    <span class="vi">@context = </span><span class="k">if</span> <span class="nx">contexts</span> <span class="k">instanceof</span> <span class="nx">RenderContext</span> <span class="k">then</span> <span class="nx">contexts</span> <span class="k">else</span> <span class="k">new</span> <span class="nx">RenderContext</span><span class="p">(</span><span class="nx">contexts</span><span class="p">...)</span>
    <span class="nx">setTimeout</span> <span class="nx">@start</span><span class="p">,</span> <span class="mi">0</span>

  <span class="nv">start: </span><span class="o">=&gt;</span>
    <span class="vi">@startTime = </span><span class="k">new</span> <span class="nb">Date</span>
    <span class="nx">@parseNode</span> <span class="nx">@node</span>

  <span class="nv">resume: </span><span class="o">=&gt;</span>
    <span class="vi">@startTime = </span><span class="k">new</span> <span class="nb">Date</span>
    <span class="nx">@parseNode</span> <span class="nx">@resumeNode</span>

  <span class="nv">finish: </span><span class="o">-&gt;</span>
    <span class="vi">@startTime = </span><span class="kc">null</span>
    <span class="nx">@callback</span><span class="o">?</span><span class="p">()</span>
    <span class="nx">@fire</span> <span class="s1">&#39;rendered&#39;</span>

  <span class="nv">forgetAll: </span><span class="o">-&gt;</span>

  <span class="nv">rendered: </span><span class="nx">@eventOneShot</span> <span class="o">-&gt;</span>

  <span class="nv">bindingRegexp = </span><span class="sr">/data\-(.*)/</span>
  <span class="nv">sortBindings = </span><span class="nf">(a, b) -&gt;</span>
    <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;foreach&#39;</span>
      <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;foreach&#39;</span>
      <span class="mi">1</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;formfor&#39;</span>
      <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;formfor&#39;</span>
      <span class="mi">1</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bind&#39;</span>
      <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bind&#39;</span>
      <span class="mi">1</span>
    <span class="k">else</span>
      <span class="mi">0</span>

  <span class="nv">parseNode: </span><span class="nf">(node) -&gt;</span>
    <span class="k">if</span> <span class="k">new</span> <span class="nb">Date</span> <span class="o">-</span> <span class="nx">@startTime</span> <span class="o">&gt;</span> <span class="mi">50</span>
      <span class="vi">@resumeNode = </span><span class="nx">node</span>
      <span class="nx">setTimeout</span> <span class="nx">@resume</span><span class="p">,</span> <span class="mi">0</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span>
      <span class="nv">bindings = </span><span class="k">for</span> <span class="nx">attr</span> <span class="k">in</span> <span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span>
        <span class="nv">name = </span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">bindingRegexp</span><span class="p">)</span><span class="o">?</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">continue</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">name</span>
        <span class="k">if</span> <span class="o">~</span><span class="p">(</span><span class="nv">varIndex = </span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>
          <span class="p">[</span><span class="nx">name</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">varIndex</span><span class="p">),</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">varIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span>

      <span class="k">for</span> <span class="nx">readerArgs</span> <span class="k">in</span> <span class="nx">bindings</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sortBindings</span><span class="p">)</span>
        <span class="nv">result = </span><span class="k">if</span> <span class="nx">readerArgs</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">readers</span><span class="p">[</span><span class="nx">readerArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">?</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">readerArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">@context</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">[</span><span class="nx">readerArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">?</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">readerArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">readerArgs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">@context</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>

        <span class="k">if</span> <span class="nx">result</span> <span class="o">is</span> <span class="kc">false</span>
          <span class="nv">skipChildren = </span><span class="kc">true</span>
          <span class="k">break</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">nextNode = </span><span class="nx">@nextNode</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">skipChildren</span><span class="p">))</span> <span class="k">then</span> <span class="nx">@parseNode</span><span class="p">(</span><span class="nx">nextNode</span><span class="p">)</span> <span class="k">else</span> <span class="nx">@finish</span><span class="p">()</span>

  <span class="nv">nextNode: </span><span class="nf">(node, skipChildren) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">skipChildren</span>
      <span class="nv">children = </span><span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span>
      <span class="k">return</span> <span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">children</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>

    <span class="nx">node</span><span class="p">.</span><span class="nx">onParseExit</span><span class="o">?</span><span class="p">()</span>

    <span class="nv">sibling = </span><span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span>
    <span class="k">return</span> <span class="nx">sibling</span> <span class="k">if</span> <span class="nx">sibling</span>

    <span class="nv">nextParent = </span><span class="nx">node</span>
    <span class="k">while</span> <span class="nv">nextParent = </span><span class="nx">nextParent</span><span class="p">.</span><span class="nx">parentNode</span>
      <span class="nx">nextParent</span><span class="p">.</span><span class="nx">onParseExit</span><span class="o">?</span><span class="p">()</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">isSameNode</span><span class="p">(</span><span class="nx">nextParent</span><span class="p">)</span>

      <span class="nv">parentSibling = </span><span class="nx">nextParent</span><span class="p">.</span><span class="nx">nextSibling</span>
      <span class="k">return</span> <span class="nx">parentSibling</span> <span class="k">if</span> <span class="nx">parentSibling</span>

    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Bindings are shortlived objects which manage the observation of any keypaths a <code>data</code> attribute depends on.
Bindings parse any keypaths which are filtered and use an accessor to apply the filters, and thus enjoy
the automatic trigger and dependency system that Batman.Objects use.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Binding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>A beastly regular expression for pulling keypaths out of the JSON arguments to a filter.
It makes the following matches:</p>

<ul>
<li><code>foo</code> and <code>baz.qux</code> in <code>foo, "bar", baz.qux</code></li>
<li><code>foo.bar.baz</code> in <code>true, false, "true", "false", foo.bar.baz</code></li>
<li><code>true.bar</code> in <code>2, true.bar</code></li>
<li><code>truesay</code> in truesay</li>
<li>no matches in <code>"bar", 2, {"x":"y", "Z": foo.bar.baz}, "baz"</code></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">keypath_rx = </span><span class="err">///</span>
    <span class="p">(</span><span class="o">?:^|</span><span class="p">,)</span>           <span class="c1"># Match either the start of an arguments list or the start of a space inbetween commas.</span>
    <span class="err">\</span><span class="nx">s</span><span class="o">*</span>               <span class="c1"># Be insensitive to whitespace between the comma and the actual arguments.</span>
    <span class="p">(</span><span class="o">?!</span>               <span class="c1"># Use a lookahead to ensure we aren&#39;t matching true or false:</span>
      <span class="p">(</span><span class="o">?:</span><span class="kc">true</span><span class="o">|</span><span class="kc">false</span><span class="p">)</span>  <span class="c1"># Match either true or false ...</span>
      <span class="err">\</span><span class="nx">s</span><span class="o">*</span>             <span class="c1"># and make sure that there&#39;s nothing else that comes after the true or false ...</span>
      <span class="p">(</span><span class="o">?:</span><span class="nx">$</span><span class="o">|</span><span class="p">,)</span>         <span class="c1"># before the end of this argument in the list.</span>
    <span class="p">)</span>
    <span class="p">([</span><span class="nx">a</span><span class="o">-</span><span class="nx">zA</span><span class="o">-</span><span class="nx">Z</span><span class="p">][</span><span class="err">\</span><span class="nx">w</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span> <span class="c1"># Now that true and false can&#39;t be matched, match a dot delimited list of keys.</span>
    <span class="err">\</span><span class="nx">s</span><span class="o">*</span>               <span class="c1"># Be insensitive to whitespace before the next comma or end of the filter arguments list.</span>
    <span class="p">(</span><span class="o">?:</span><span class="nx">$</span><span class="o">|</span><span class="p">,)</span>           <span class="c1"># Match either the next comma or the end of the filter arguments list.</span>
    <span class="o">/</span><span class="err">//</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>A less beastly regular expression for pulling out the [] syntax <code>get</code>s in a binding string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_rx = </span><span class="sr">/(\w)\[(.+?)\]/</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>The <code>filteredValue</code> which calculates the final result by reducing the initial value through all the filters.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="s1">&#39;filteredValue&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nv">value = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;unfilteredValue&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">@filterFunctions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@filterFunctions</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">value</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Get any argument keypaths from the context stored at parse time.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">args = </span><span class="nx">@filterArguments</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">map</span> <span class="nf">(argument) -&gt;</span>
          <span class="k">if</span> <span class="nx">argument</span><span class="p">.</span><span class="nx">_keypath</span>
            <span class="nx">argument</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">argument</span><span class="p">.</span><span class="nx">_keypath</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="nx">argument</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Apply the filter.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">fn</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">args</span><span class="p">...)</span>
      <span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>The <code>unfilteredValue</code> is whats evaluated each time any dependents change.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="s1">&#39;unfilteredValue&#39;</span><span class="p">,</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>If we're working with an <code>@key</code> and not an <code>@value</code>, find the context the key belongs to so we can
hold a reference to it for passing to the <code>dataChange</code> and <code>nodeChange</code> observers.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">k = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
      <span class="nx">@get</span><span class="p">(</span><span class="s2">&quot;keyContext.#{k}&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>The <code>keyContext</code> accessor is</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="s1">&#39;keyContext&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">unless</span> <span class="nx">@_keyContext</span>
      <span class="p">[</span><span class="nx">unfilteredValue</span><span class="p">,</span> <span class="nx">@_keyContext</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@renderContext</span><span class="p">.</span><span class="nx">findKey</span> <span class="nx">@key</span>
    <span class="nx">@_keyContext</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>Pull out the key and filter from the <code>@keyPath</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@parseFilter</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>Define the default observers.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@nodeChange</span> <span class="o">||=</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">@key</span>
        <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;keyContext&#39;</span><span class="p">).</span><span class="nx">set</span> <span class="nx">@key</span><span class="p">,</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">value</span>
    <span class="nx">@dataChange</span> <span class="o">||=</span> <span class="nf">(value, node) -&gt;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">valueForNode</span> <span class="nx">@node</span><span class="p">,</span> <span class="nx">value</span>

    <span class="nv">shouldSet = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>And attach them.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">nodeIsEditable</span><span class="p">(</span><span class="nx">@node</span><span class="p">)</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">change</span> <span class="nx">@node</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="nv">shouldSet = </span><span class="kc">no</span>
        <span class="nx">@nodeChange</span><span class="p">(</span><span class="nx">@node</span><span class="p">,</span> <span class="nx">@_keyContext</span> <span class="o">||</span> <span class="nx">@value</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>
        <span class="nv">shouldSet = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>Observe the value of this binding's <code>filteredValue</code> and fire it immediately to update the node.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@observe</span> <span class="s1">&#39;filteredValue&#39;</span><span class="p">,</span> <span class="kc">yes</span><span class="p">,</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">shouldSet</span>
        <span class="nx">@dataChange</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">@node</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>
    <span class="err">@</span>

  <span class="nv">parseFilter: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>Store the function which does the filtering and the arguments (all except the actual value to apply the
filter to) in these arrays.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@filterFunctions = </span><span class="p">[]</span>
    <span class="vi">@filterArguments = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>Rewrite [] style gets, replace quotes to be JSON friendly, and split the string by pipes to see if there are any filters.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">filters = </span><span class="nx">@keyPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">get_rx</span><span class="p">,</span> <span class="s2">&quot;$1 | get $2 &quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&#39;/g</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="sr">/(?!&quot;)\s+\|\s+(?!&quot;)/</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>The key will is always the first token before the pipe.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">try</span>
      <span class="nv">key = </span><span class="nx">@parseSegment</span><span class="p">(</span><span class="nv">orig = </span><span class="nx">filters</span><span class="p">.</span><span class="nx">shift</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">catch</span> <span class="nx">e</span>
      <span class="k">throw</span> <span class="s2">&quot;Bad binding keypath \&quot;#{orig}\&quot;!&quot;</span>
    <span class="k">if</span> <span class="nx">key</span><span class="p">.</span><span class="nx">_keypath</span>
      <span class="vi">@key = </span><span class="nx">key</span><span class="p">.</span><span class="nx">_keypath</span>
    <span class="k">else</span>
      <span class="vi">@value = </span><span class="nx">key</span>

    <span class="k">if</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">while</span> <span class="nv">filterString = </span><span class="nx">filters</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>For each filter, get the name and the arguments by splitting on the first space.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">split = </span><span class="nx">filterString</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">~</span><span class="nx">split</span>
          <span class="nv">filterName = </span><span class="nx">filterString</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">split</span><span class="p">)</span>
          <span class="nv">args = </span><span class="nx">filterString</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">split</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nv">filterName = </span><span class="nx">filterString</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p>If the filter exists, grab it.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nv">filter = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Filters</span><span class="p">[</span><span class="nx">filterName</span><span class="p">]</span>
          <span class="nx">@filterFunctions</span><span class="p">.</span><span class="nx">push</span> <span class="nx">filter</span></pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p>Get the arguments for the filter by parsing the args as JSON, or
just pushing an placeholder array</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">args</span>
            <span class="k">try</span>
              <span class="nx">@filterArguments</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@parseSegment</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
            <span class="k">catch</span> <span class="nx">e</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Bad filter arguments \&quot;#{args}\&quot;!&quot;</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="nx">@filterArguments</span><span class="p">.</span><span class="nx">push</span> <span class="p">[]</span>
        <span class="k">else</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unrecognized filter &#39;#{filterName}&#39; in key \&quot;#{@keyPath}\&quot;!&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>Map over each array of arguments to grab the context for any keypaths.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@filterArguments = </span><span class="nx">@filterArguments</span><span class="p">.</span><span class="nx">map</span> <span class="p">(</span><span class="nx">argumentList</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">argumentList</span><span class="p">.</span><span class="nx">map</span> <span class="p">(</span><span class="nx">argument</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="k">if</span> <span class="nx">argument</span><span class="p">.</span><span class="nx">_keypath</span></pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>Discard the value (for the time being) and store the context for the keypath in <code>context</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">[</span><span class="nx">_</span><span class="p">,</span> <span class="nx">argument</span><span class="p">.</span><span class="nx">context</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@renderContext</span><span class="p">.</span><span class="nx">findKey</span> <span class="nx">argument</span><span class="p">.</span><span class="nx">_keypath</span>
          <span class="nx">argument</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <p>Turn a piece of a <code>data</code> keypath into a usable javascript object.
 + replacing keypaths using the above regular expression
 + wrapping the <code>,</code> delimited list in square brackets
 + and <code>JSON.parse</code>ing them as an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parseSegment: </span><span class="nf">(segment) -&gt;</span>
    <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">keypath_rx</span><span class="p">,</span> <span class="s2">&quot;{\&quot;_keypath\&quot;: \&quot;$1\&quot;}&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>The Render context class manages the stack of contexts accessible to a view during rendering.
Every, and I really mean every method which uses filters has to be defined in terms of a new
binding, or by using the RenderContext.bind method. This is so that the proper order of objects
is traversed and any observers are properly attached.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">RenderContext</span>
  <span class="nv">constructor: </span><span class="nf">(contexts...) -&gt;</span>
    <span class="vi">@contexts = </span><span class="nx">contexts</span>
    <span class="vi">@storage = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
    <span class="nx">@contexts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@storage</span>

  <span class="nv">findKey: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">base = </span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span>
    <span class="nv">i = </span><span class="nx">@contexts</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">while</span> <span class="nx">i</span><span class="o">--</span>
      <span class="nv">context = </span><span class="nx">@contexts</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">context</span><span class="p">.</span><span class="nx">get</span><span class="o">?</span>
        <span class="nv">val = </span><span class="nx">context</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">val = </span><span class="nx">context</span><span class="p">[</span><span class="nx">base</span><span class="p">]</span>

      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">val</span> <span class="o">isnt</span> <span class="s1">&#39;undefined&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>we need to pass the check if the basekey exists, even if the intermediary keys do not.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="p">[</span><span class="nx">$get</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">key</span><span class="p">),</span> <span class="nx">context</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">[</span><span class="nx">container</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span> <span class="nx">container</span><span class="p">]</span>

  <span class="nv">set: </span><span class="nf">(args...) -&gt;</span>
    <span class="nx">@storage</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span>

  <span class="nv">push: </span><span class="nf">(x) -&gt;</span>
    <span class="nx">@contexts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>

  <span class="nv">pop: </span><span class="o">-&gt;</span>
    <span class="nx">@contexts</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>

  <span class="nv">clone: </span><span class="o">-&gt;</span>
    <span class="nv">context = </span><span class="k">new</span> <span class="nx">@constructor</span><span class="p">(</span><span class="nx">@contexts</span><span class="p">...)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">setStorage</span><span class="p">(</span><span class="nx">@storage</span><span class="p">)</span>
    <span class="nx">context</span>

  <span class="nv">setStorage: </span><span class="nf">(storage) -&gt;</span>
    <span class="nx">@contexts</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">@contexts</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">@storage</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">@push</span><span class="p">(</span><span class="nx">storage</span><span class="p">)</span>
    <span class="nx">storage</span></pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <p><code>BindingProxy</code> is a simple class which assists in allowing bound contexts to be popped to the top of
the stack. This happens when a <code>data-context</code> is descended into, for each iteration in a <code>data-foreach</code>,
and in other specific HTML bindings like <code>data-formfor</code>. <code>BindingProxy</code>s use accessors so that if the
value of the binding they proxy changes, the changes will be propagated to any thing observing it.
This is good because it allows <code>data-context</code> to take filtered keys and even filters which take
keypath arguments, calculate the context to descend into when any of those keys change, and importantly
expose a friendly <code>Batman.Object</code> interface for the rest of the <code>Binding</code> code to work with.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">class</span> <span class="nx">BindingProxy</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
    <span class="nv">isBindingProxy: </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <p>Take the <code>binding</code> which needs to be proxied, and optionally rest it at the <code>localKey</code> scope.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">constructor: </span><span class="nf">(@binding, @localKey) -&gt;</span>
      <span class="k">if</span> <span class="nx">@localKey</span>
        <span class="nx">@accessor</span> <span class="nx">@localKey</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@binding</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;filteredValue&#39;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">@accessor</span> <span class="nf">(key) -&gt;</span> <span class="nx">@binding</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;filteredValue.#{key}&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <p>Below are the two primitives that all the <code>Batman.DOM</code> helpers are composed of.
<code>addKeyToScopeForNode</code> takes a <code>node</code>, <code>key</code>, and optionally a <code>localName</code>. It creates a <code>Binding</code> to
the key (such that the key can contain filters and many keypaths in arguments), and then pushes the
bound value onto the stack of contexts for the given <code>node</code>. If <code>localName</code> is given, the bound value
is available using that identifier in child bindings. Otherwise, the value itself is pushed onto the
context stack and member properties can be accessed directly in child bindings.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">addKeyToScopeForNode: </span><span class="nf">(node, key, localName) -&gt;</span>
    <span class="nx">@bind</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">binding</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">@push</span> <span class="k">new</span> <span class="nx">BindingProxy</span><span class="p">(</span><span class="nx">binding</span><span class="p">,</span> <span class="nx">localName</span><span class="p">)</span>
    <span class="p">,</span> <span class="o">-&gt;</span>
      <span class="kc">true</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p>Pop the <code>BindingProxy</code> off the stack once this node has been parsed.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">node.onParseExit = </span><span class="o">=&gt;</span>
      <span class="nx">@pop</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <p><code>bind</code> takes a <code>node</code>, a <code>key</code>, and observers for when the <code>dataChange</code>s and the <code>nodeChange</code>s. It
creates a <code>Binding</code> to the key (supporting filters and the context stack), which fires the observers
when appropriate. Note that <code>Binding</code> has default observers for <code>dataChange</code> and <code>nodeChange</code> that
will set node/object values if these observers aren't passed in here.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bind: </span><span class="nf">(node, key, dataChange, nodeChange) -&gt;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Binding</span>
      <span class="nv">renderContext: </span><span class="err">@</span>
      <span class="nv">keyPath: </span><span class="nx">key</span>
      <span class="nv">node: </span><span class="nx">node</span>
      <span class="nv">dataChange: </span><span class="nx">dataChange</span>
      <span class="nv">nodeChange: </span><span class="nx">nodeChange</span>

<span class="nv">Batman.DOM = </span><span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <p><code>Batman.DOM.readers</code> contains the functions used for binding a node's value or innerHTML, showing/hiding nodes,
and any other <code>data-#{name}=""</code> style DOM directives.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readers: </span><span class="p">{</span>
    <span class="nv">bind: </span><span class="nf">(node, key, context) -&gt;</span>
      <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span> <span class="o">and</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;checkbox&#39;</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;checked&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;select&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>wait for the select to render before binding to it
FIXME expose the renderer's rendered event in the view?</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">view = </span><span class="nx">context</span><span class="p">.</span><span class="nx">findKey</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">_renderer</span><span class="p">.</span><span class="nx">rendered</span> <span class="o">-&gt;</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>

    <span class="nv">context: </span><span class="nf">(node, key, context) -&gt;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">addKeyToScopeForNode</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>

    <span class="nv">mixin: </span><span class="nf">(node, key, context) -&gt;</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">mixins</span><span class="p">)</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nf">(mixin) -&gt;</span>
        <span class="nx">$mixin</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">mixin</span>
      <span class="p">,</span> <span class="o">-&gt;</span><span class="p">)</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>

    <span class="nv">showif: </span><span class="nf">(node, key, context, renderer, invert) -&gt;</span>
      <span class="nv">originalDisplay = </span><span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span>
      <span class="nv">originalDisplay = </span><span class="s1">&#39;block&#39;</span> <span class="k">if</span> <span class="o">!</span><span class="nx">originalDisplay</span> <span class="o">or</span> <span class="nx">originalDisplay</span> <span class="o">is</span> <span class="s1">&#39;none&#39;</span>

      <span class="nx">context</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nf">(value) -&gt;</span>
        <span class="k">if</span> <span class="o">!!</span><span class="nx">value</span> <span class="o">is</span> <span class="o">!</span><span class="nx">invert</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">show</span><span class="o">?</span><span class="p">()</span>
          <span class="nv">node.style.display = </span><span class="nx">originalDisplay</span>
        <span class="k">else</span>
          <span class="k">if</span> <span class="k">typeof</span> <span class="nx">node</span><span class="p">.</span><span class="nx">hide</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="nx">node</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span> <span class="k">else</span> <span class="nv">node.style.display = </span><span class="s1">&#39;none&#39;</span>
      <span class="p">,</span> <span class="o">-&gt;</span> <span class="p">)</span>

    <span class="nv">hideif: </span><span class="nf">(args...) -&gt;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">readers</span><span class="p">.</span><span class="nx">showif</span> <span class="nx">args</span><span class="p">...,</span> <span class="kc">yes</span>

    <span class="nv">route: </span><span class="nf">(node, key, context) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p>you must specify the / in front to route directly to hash route</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;/&#39;</span>
        <span class="nv">url = </span><span class="nx">key</span>
      <span class="k">else</span>
        <span class="nv">route = </span><span class="nx">context</span><span class="p">.</span><span class="nx">get</span> <span class="nx">key</span>

        <span class="k">if</span> <span class="nx">route</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Model</span>
          <span class="nv">name = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span>
          <span class="nv">url = </span><span class="nx">context</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">findUrl</span><span class="p">({</span><span class="nv">resource: </span><span class="nx">name</span><span class="p">,</span> <span class="nv">id: </span><span class="nx">route</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)})</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">route</span><span class="p">.</span><span class="nx">prototype</span>
          <span class="nv">name = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span>
          <span class="nv">url = </span><span class="nx">context</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">findUrl</span><span class="p">({</span><span class="nv">resource: </span><span class="nx">name</span><span class="p">})</span>

      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">url</span>

      <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;A&#39;</span>
        <span class="nv">node.href = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">HashHistory</span><span class="o">::</span><span class="nx">urlFor</span> <span class="nx">url</span>

      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">click</span> <span class="nx">node</span><span class="p">,</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">$redirect</span> <span class="nx">url</span><span class="p">)</span>

    <span class="nv">partial: </span><span class="nf">(node, path, context) -&gt;</span>
      <span class="nv">view = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span>
        <span class="nv">source: </span><span class="nx">path</span> <span class="o">+</span> <span class="s1">&#39;.html&#39;</span>
        <span class="nv">contentFor: </span><span class="nx">node</span>
        <span class="nv">contexts: </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">contexts</span><span class="p">)</span>

    <span class="nv">yield: </span><span class="nf">(node, key) -&gt;</span>
      <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">yield</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">node</span><span class="p">),</span> <span class="mi">0</span>

    <span class="nv">contentfor: </span><span class="nf">(node, key) -&gt;</span>
      <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">contentFor</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">node</span><span class="p">),</span> <span class="mi">0</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p><code>Batman.DOM.attrReaders</code> contains all the DOM directives which take an argument in their name, in the
<code>data-dosomething-argument="keypath"</code> style. This means things like foreach, binding attributes like
disabled or anything arbitrary, descending into a context, binding specific classes, or binding to events.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">attrReaders: </span><span class="p">{</span>
    <span class="nv">_parseAttribute: </span><span class="nf">(value) -&gt;</span>
      <span class="k">if</span> <span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;false&#39;</span> <span class="k">then</span> <span class="nv">value = </span><span class="kc">false</span>
      <span class="k">if</span> <span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;true&#39;</span> <span class="k">then</span> <span class="nv">value = </span><span class="kc">true</span>
      <span class="nx">value</span>

    <span class="nv">bind: </span><span class="nf">(node, attr, key, context) -&gt;</span>
      <span class="k">switch</span> <span class="nx">attr</span>
        <span class="k">when</span> <span class="s1">&#39;checked&#39;</span><span class="p">,</span> <span class="s1">&#39;disabled&#39;</span>
          <span class="nv">contextChange = </span><span class="nf">(value) -&gt;</span> <span class="nx">node</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">value</span>
          <span class="nv">nodeChange = </span><span class="nf">(node, subContext) -&gt;</span> <span class="nx">subContext</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">_parseAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">attr</span><span class="p">]))</span>
        <span class="k">when</span> <span class="s1">&#39;value&#39;</span>
          <span class="nv">contextChange = </span><span class="nf">(value) -&gt;</span> <span class="nv">node.value = </span><span class="nx">value</span>
          <span class="nv">nodeChange = </span><span class="nf">(node, subContext) -&gt;</span> <span class="nx">subContext</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">_parseAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">value</span><span class="p">))</span>
        <span class="k">else</span>
          <span class="nv">contextChange = </span><span class="nf">(value) -&gt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
          <span class="nv">nodeChange = </span><span class="nf">(node, subContext) -&gt;</span> <span class="nx">subContext</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">_parseAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">attr</span><span class="p">)))</span>

      <span class="nx">context</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">contextChange</span><span class="p">,</span> <span class="nx">nodeChange</span><span class="p">)</span>

    <span class="nv">context: </span><span class="nf">(node, contextName, key, context) -&gt;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">addKeyToScopeForNode</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">contextName</span><span class="p">)</span>

    <span class="nv">event: </span><span class="nf">(node, eventName, key, context) -&gt;</span>
      <span class="k">if</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;@&#39;</span>
        <span class="nv">callback = </span><span class="k">new</span> <span class="nb">Function</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="p">[</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">subContext</span><span class="p">]</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">findKey</span> <span class="nx">key</span>

      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="nx">node</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nv">confirmText = </span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-confirm&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">confirmText</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">confirm</span><span class="p">(</span><span class="nx">confirmText</span><span class="p">)</span>
          <span class="k">return</span>
        <span class="nv">x = </span><span class="nx">eventName</span>
        <span class="nv">x = </span><span class="nx">key</span>
        <span class="nx">callback</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">subContext</span><span class="p">,</span> <span class="nx">arguments</span>

    <span class="nv">addclass: </span><span class="nf">(node, className, key, context, parentRenderer, invert) -&gt;</span>
      <span class="nv">className = </span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\|/g</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="c1">#this will let you add or remove multiple class names in one binding</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nf">(value) -&gt;</span>
        <span class="nv">currentName = </span><span class="nx">node</span><span class="p">.</span><span class="nx">className</span>
        <span class="nv">includesClassName = </span><span class="nx">currentName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="o">!!</span><span class="nx">value</span> <span class="o">is</span> <span class="o">!</span><span class="nx">invert</span>
          <span class="nv">node.className = </span><span class="s2">&quot;#{currentName} #{className}&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="nx">includesClassName</span>
        <span class="k">else</span>
          <span class="nv">node.className = </span><span class="nx">currentName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">className</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">includesClassName</span>
      <span class="p">,</span> <span class="o">-&gt;</span>

    <span class="nv">removeclass: </span><span class="nf">(args...) -&gt;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">addclass</span> <span class="nx">args</span><span class="p">...,</span> <span class="kc">yes</span>

    <span class="nv">foreach: </span><span class="nf">(node, iteratorName, key, context, parentRenderer) -&gt;</span>
      <span class="nv">prototype = </span><span class="nx">node</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">true</span>
      <span class="nx">prototype</span><span class="p">.</span><span class="nx">removeAttribute</span> <span class="s2">&quot;data-foreach-#{iteratorName}&quot;</span>

      <span class="nv">parent = </span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span>
      <span class="nv">sibling = </span><span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span>
      <span class="nv">fragment = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">()</span>
      <span class="nv">numPendingChildren = </span><span class="mi">0</span>
      <span class="nv">node.onParseExit = </span><span class="o">-&gt;</span>
        <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">node</span><span class="p">),</span> <span class="mi">0</span>

      <span class="nv">nodeMap = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Hash</span>
      <span class="nv">observers = </span><span class="p">{}</span>
      <span class="nv">oldCollection = </span><span class="kc">false</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nf">(collection) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p>Track the old collection so that if it changes, we can remove the observers we attached,
and only observe the new collection.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">oldCollection</span>
          <span class="nx">nodeMap</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(item, node) -&gt;</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">node</span>
          <span class="nx">oldCollection</span><span class="p">.</span><span class="nx">forget</span> <span class="s1">&#39;itemsWereAdded&#39;</span><span class="p">,</span> <span class="nx">observers</span><span class="p">.</span><span class="nx">add</span>
          <span class="nx">oldCollection</span><span class="p">.</span><span class="nx">forget</span> <span class="s1">&#39;itemsWereRemoved&#39;</span><span class="p">,</span> <span class="nx">observers</span><span class="p">.</span><span class="nx">remove</span>
          <span class="nx">oldCollection</span><span class="p">.</span><span class="nx">forget</span> <span class="s1">&#39;setWasSorted&#39;</span><span class="p">,</span> <span class="nx">observers</span><span class="p">.</span><span class="nx">reorder</span>
        <span class="nv">oldCollection = </span><span class="nx">collection</span>

        <span class="nv">observers.add = </span><span class="nf">(items...) -&gt;</span>
          <span class="nx">numPendingChildren</span> <span class="o">+=</span> <span class="nx">items</span><span class="p">.</span><span class="nx">length</span>
          <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span>
            <span class="nx">parentRenderer</span><span class="p">.</span><span class="nx">prevent</span> <span class="s1">&#39;rendered&#39;</span>

            <span class="nv">newNode = </span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">true</span>
            <span class="nx">nodeMap</span><span class="p">.</span><span class="nx">set</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">newNode</span>

            <span class="nv">localClone = </span><span class="nx">context</span><span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
            <span class="nv">iteratorContext = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
            <span class="nx">iteratorContext</span><span class="p">[</span><span class="nx">iteratorName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span>
            <span class="nx">localClone</span><span class="p">.</span><span class="nx">push</span> <span class="nx">iteratorContext</span>
            <span class="nx">localClone</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span>

            <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Renderer</span> <span class="nx">newNode</span><span class="p">,</span> <span class="nx">do</span> <span class="nf">(newNode) -&gt;</span>
              <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">isSorted</span><span class="o">?</span><span class="p">()</span>
                  <span class="nx">observers</span><span class="p">.</span><span class="nx">reorder</span><span class="p">()</span>
                <span class="k">else</span>
                  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">newNode</span><span class="p">.</span><span class="nx">show</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
                    <span class="nx">newNode</span><span class="p">.</span><span class="nx">show</span> <span class="nv">before: </span><span class="nx">sibling</span>
                  <span class="k">else</span>
                    <span class="nx">fragment</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">newNode</span>

                <span class="k">if</span> <span class="o">--</span><span class="nx">numPendingChildren</span> <span class="o">==</span> <span class="mi">0</span>
                  <span class="nx">parent</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">fragment</span><span class="p">,</span> <span class="nx">sibling</span>
                  <span class="nv">fragment = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">()</span>

                <span class="nx">parentRenderer</span><span class="p">.</span><span class="nx">allow</span> <span class="s1">&#39;ready&#39;</span>
                <span class="nx">parentRenderer</span><span class="p">.</span><span class="nx">allow</span> <span class="s1">&#39;rendered&#39;</span>
                <span class="nx">parentRenderer</span><span class="p">.</span><span class="nx">fire</span> <span class="s1">&#39;rendered&#39;</span>
            <span class="p">,</span> <span class="nx">localClone</span>

        <span class="nv">observers.remove = </span><span class="nf">(items...) -&gt;</span>
          <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span>
            <span class="nv">oldNode = </span><span class="nx">nodeMap</span><span class="p">.</span><span class="nx">get</span> <span class="nx">item</span>
            <span class="nx">nodeMap</span><span class="p">.</span><span class="nx">unset</span> <span class="nx">item</span>
            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">oldNode</span><span class="p">.</span><span class="nx">hide</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
              <span class="nx">oldNode</span><span class="p">.</span><span class="nx">hide</span> <span class="kc">yes</span>
            <span class="k">else</span>
              <span class="nx">oldNode</span><span class="o">?</span><span class="p">.</span><span class="nx">parentNode</span><span class="o">?</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">oldNode</span>
          <span class="kc">true</span>

        <span class="nv">observers.reorder = </span><span class="o">-&gt;</span>
          <span class="nv">items = </span><span class="nx">collection</span><span class="p">.</span><span class="nx">toArray</span><span class="p">()</span>
          <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span>
            <span class="nv">thisNode = </span><span class="nx">nodeMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">thisNode</span><span class="p">.</span><span class="nx">show</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
              <span class="nx">thisNode</span><span class="p">.</span><span class="nx">show</span> <span class="nv">before: </span><span class="nx">sibling</span>
            <span class="k">else</span>
              <span class="nx">parent</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">thisNode</span><span class="p">,</span> <span class="nx">sibling</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p>Observe the collection for events in the future</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">collection</span><span class="o">?</span><span class="p">.</span><span class="nx">observe</span>
          <span class="nx">collection</span><span class="p">.</span><span class="nx">observe</span> <span class="s1">&#39;itemsWereAdded&#39;</span><span class="p">,</span> <span class="nx">observers</span><span class="p">.</span><span class="nx">add</span>
          <span class="nx">collection</span><span class="p">.</span><span class="nx">observe</span> <span class="s1">&#39;itemsWereRemoved&#39;</span><span class="p">,</span> <span class="nx">observers</span><span class="p">.</span><span class="nx">remove</span>
          <span class="nx">collection</span><span class="p">.</span><span class="nx">observe</span> <span class="s1">&#39;setWasSorted&#39;</span><span class="p">,</span> <span class="nx">observers</span><span class="p">.</span><span class="nx">reorder</span></pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p>Add all the already existing items. For hash-likes, add the key.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">forEach</span>
          <span class="nx">collection</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(item) -&gt;</span> <span class="nx">observers</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">collection</span>
          <span class="nx">observers</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
      <span class="p">,</span> <span class="o">-&gt;</span> <span class="p">)</span>

      <span class="kc">false</span> <span class="c1"># Return false so the Renderer doesn&#39;t descend into this node&#39;s children.</span>

    <span class="nv">formfor: </span><span class="nf">(node, localName, key, context) -&gt;</span>
      <span class="nv">binding = </span><span class="nx">context</span><span class="p">.</span><span class="nx">addKeyToScopeForNode</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">localName</span><span class="p">)</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">submit</span> <span class="nx">node</span><span class="p">,</span> <span class="nf">(node, e) -&gt;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p><code>Batman.DOM.events</code> contains the helpers used for binding to events. These aren't called by
DOM directives, but are used to handle specific events by the <code>data-event-#{name}</code> helper.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">events: </span><span class="p">{</span>
    <span class="nv">click: </span><span class="nf">(node, callback) -&gt;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
        <span class="nx">callback</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>
        <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">preventDefault</span><span class="p">()</span>

      <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;A&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">node</span><span class="p">.</span><span class="nx">href</span>
        <span class="nv">node.href = </span><span class="s1">&#39;#&#39;</span>

      <span class="nx">node</span>

    <span class="nv">change: </span><span class="nf">(node, callback) -&gt;</span>
      <span class="nv">eventNames = </span><span class="k">switch</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
        <span class="k">when</span> <span class="s1">&#39;TEXTAREA&#39;</span> <span class="k">then</span> <span class="p">[</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">]</span>
        <span class="k">when</span> <span class="s1">&#39;INPUT&#39;</span>
          <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;TEXT&#39;</span>
            <span class="nv">oldCallback = </span><span class="nx">callback</span>
            <span class="nv">callback = </span><span class="nf">(e) -&gt;</span>
              <span class="k">return</span> <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;keyup&#39;</span> <span class="o">&amp;&amp;</span> <span class="mi">13</span> <span class="o">&lt;=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">&lt;=</span> <span class="mi">14</span>
              <span class="nx">oldCallback</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...)</span>
            <span class="p">[</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">]</span>
          <span class="k">else</span>
            <span class="p">[</span><span class="s1">&#39;change&#39;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;change&#39;</span><span class="p">]</span>

      <span class="k">for</span> <span class="nx">eventName</span> <span class="k">in</span> <span class="nx">eventNames</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
          <span class="nx">callback</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>

    <span class="nv">submit: </span><span class="nf">(node, callback) -&gt;</span>
      <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">nodeIsEditable</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
          <span class="k">if</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">keyCode</span> <span class="o">is</span> <span class="mi">13</span>
            <span class="nx">callback</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>
            <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">preventDefault</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
          <span class="nx">callback</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>
          <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">preventDefault</span><span class="p">()</span>

      <span class="nx">node</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p><code>yield</code> and <code>contentFor</code> are used to declare partial views and then pull them in elsewhere.
This can be used for abstraction as well as repetition.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">yield: </span><span class="nf">(name, node) -&gt;</span>
    <span class="nv">yields = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yields</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="nx">yields</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">content = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yieldContents</span><span class="o">?</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span>
      <span class="nv">node.innerHTML = </span><span class="s1">&#39;&#39;</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="k">if</span> <span class="nx">content</span>

  <span class="nv">contentFor: </span><span class="nf">(name, node) -&gt;</span>
    <span class="nv">contents = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yieldContents</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="nx">contents</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">yield = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yields</span><span class="o">?</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span>
      <span class="nv">yield.innerHTML = </span><span class="s1">&#39;&#39;</span>
      <span class="nx">yield</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="k">if</span> <span class="nx">node</span>

  <span class="nv">valueForNode: </span><span class="nf">(node, value = &#39;&#39;) -&gt;</span>
    <span class="nv">isSetting = </span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">switch</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
      <span class="k">when</span> <span class="s1">&#39;INPUT&#39;</span>
        <span class="k">if</span> <span class="nx">isSetting</span> <span class="k">then</span> <span class="p">(</span><span class="nv">node.value = </span><span class="nx">value</span><span class="p">)</span> <span class="k">else</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span>
      <span class="k">when</span> <span class="s1">&#39;TEXTAREA&#39;</span>
        <span class="k">if</span> <span class="nx">isSetting</span>
          <span class="nv">node.innerHTML = node.value = </span><span class="nx">value</span>
        <span class="k">else</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span>
      <span class="k">when</span> <span class="s1">&#39;SELECT&#39;</span>
        <span class="nv">node.value = </span><span class="nx">value</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">isSetting</span> <span class="k">then</span> <span class="p">(</span><span class="nv">node.innerHTML = </span><span class="nx">value</span><span class="p">)</span> <span class="k">else</span> <span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span>
  <span class="nv">nodeIsEditable: </span><span class="nf">(node) -&gt;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;INPUT&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXTAREA&#39;</span><span class="p">,</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">]</span>

  <span class="nv">addEventListener: </span><span class="nf">(node, eventName, callback) -&gt;</span>
    <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="kc">false</span>
    <span class="k">else</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">attachEvent</span> <span class="s2">&quot;on#{eventName}&quot;</span><span class="p">,</span> <span class="nx">callback</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <h2>Helpers</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">camelize_rx = </span><span class="sr">/(?:^|_)(.)/g</span>
<span class="nv">capitalize_rx = </span><span class="sr">/(^|\s)([a-z])/g</span>
<span class="nv">underscore_rx1 = </span><span class="sr">/([A-Z]+)([A-Z][a-z])/g</span>
<span class="nv">underscore_rx2 = </span><span class="sr">/([a-z\d])([A-Z])/g</span></pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <p>Just a few random Rails-style string helpers. You can add more
to the Batman.helpers object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">helpers = Batman.helpers = </span><span class="p">{</span>
  <span class="nv">camelize: </span><span class="nf">(string, firstLetterLower) -&gt;</span>
    <span class="nv">string = </span><span class="nx">string</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">camelize_rx</span><span class="p">,</span> <span class="nf">(str, p1) -&gt;</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">firstLetterLower</span> <span class="k">then</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="nx">string</span>

  <span class="nv">underscore: </span><span class="nf">(string) -&gt;</span>
    <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">underscore_rx1</span><span class="p">,</span> <span class="s1">&#39;$1_$2&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">underscore_rx2</span><span class="p">,</span> <span class="s1">&#39;$1_$2&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span>

  <span class="nv">singularize: </span><span class="nf">(string) -&gt;</span>
    <span class="k">if</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;ies&#39;</span>
      <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;y&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;s&#39;</span>
      <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">string</span>

  <span class="nv">pluralize: </span><span class="nf">(count, string) -&gt;</span>
    <span class="k">if</span> <span class="nx">string</span>
      <span class="k">return</span> <span class="nx">string</span> <span class="k">if</span> <span class="nx">count</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="k">else</span>
      <span class="nv">string = </span><span class="nx">count</span>

    <span class="nv">lastLetter = </span><span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">lastLetter</span> <span class="o">is</span> <span class="s1">&#39;y&#39;</span>
      <span class="s2">&quot;#{string.substr(0,string.length-1)}ies&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">lastLetter</span> <span class="o">is</span> <span class="s1">&#39;s&#39;</span>
      <span class="nx">string</span>
    <span class="k">else</span>
      <span class="s2">&quot;#{string}s&quot;</span>

  <span class="nv">capitalize: </span><span class="nf">(string) -&gt;</span> <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">capitalize_rx</span><span class="p">,</span> <span class="nf">(m,p1,p2) -&gt;</span> <span class="nx">p1</span><span class="o">+</span><span class="nx">p2</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <h2>Filters</h2>

<p><code>Batman.Filters</code> contains the simple, determininistic tranforms used in view bindings to
make life a little easier.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">buntUndefined = </span><span class="nf">(f) -&gt;</span>
  <span class="nf">(value) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="kc">undefined</span>
    <span class="k">else</span>
      <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>

<span class="nv">filters = Batman.Filters =</span>
  <span class="nv">get: </span><span class="nx">buntUndefined</span> <span class="nf">(value, key) -&gt;</span>
    <span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">get</span><span class="o">?</span>
      <span class="nx">value</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">value</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>

  <span class="o">not:</span> <span class="nf">(value) -&gt;</span>
    <span class="o">!</span> <span class="o">!!</span><span class="nx">value</span>

  <span class="nv">truncate: </span><span class="nx">buntUndefined</span> <span class="nf">(value, length, end = &quot;...&quot;) -&gt;</span>
    <span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">length</span>
      <span class="nv">value = </span><span class="nx">value</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">length</span><span class="o">-</span><span class="nx">end</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">+</span> <span class="nx">end</span>
    <span class="nx">value</span>

  <span class="nv">default: </span><span class="nf">(value, string) -&gt;</span>
    <span class="nx">value</span> <span class="o">||</span> <span class="nx">string</span>

  <span class="nv">prepend: </span><span class="nf">(value, string) -&gt;</span>
    <span class="nx">string</span> <span class="o">+</span> <span class="nx">value</span>

  <span class="nv">append: </span><span class="nf">(value, string) -&gt;</span>
    <span class="nx">value</span> <span class="o">+</span> <span class="nx">string</span>

  <span class="nv">downcase: </span><span class="nx">buntUndefined</span> <span class="nf">(value) -&gt;</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>

  <span class="nv">upcase: </span><span class="nx">buntUndefined</span> <span class="nf">(value) -&gt;</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>

  <span class="nv">pluralize: </span><span class="nx">buntUndefined</span> <span class="nf">(string, count) -&gt;</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">string</span><span class="p">)</span>

  <span class="nv">join: </span><span class="nx">buntUndefined</span> <span class="nf">(value, byWhat = &#39;&#39;) -&gt;</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">byWhat</span><span class="p">)</span>

  <span class="nv">sort: </span><span class="nx">buntUndefined</span> <span class="nf">(value) -&gt;</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">sort</span><span class="p">()</span>

  <span class="nv">map: </span><span class="nx">buntUndefined</span> <span class="nf">(value, key) -&gt;</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nf">(x) -&gt;</span> <span class="nx">x</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>

  <span class="nv">first: </span><span class="nx">buntUndefined</span> <span class="nf">(value) -&gt;</span>
    <span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;capitalize&#39;</span><span class="p">,</span> <span class="s1">&#39;singularize&#39;</span><span class="p">,</span> <span class="s1">&#39;underscore&#39;</span><span class="p">,</span> <span class="s1">&#39;camelize&#39;</span><span class="p">]</span>
  <span class="nx">filters</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">buntUndefined</span> <span class="nx">helpers</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <h2>Mixins</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">mixins = Batman.mixins = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <p>Export a few globals, and grab a reference to an object accessible from all contexts for use elsewhere.
In node, the container is the <code>global</code> object, and in the browser, the container is the window object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">container = </span><span class="k">if</span> <span class="nx">exports</span><span class="o">?</span>
  <span class="nv">module.exports = </span><span class="nx">Batman</span>
  <span class="nx">global</span>
<span class="k">else</span>
  <span class="nb">window</span><span class="p">.</span><span class="nv">Batman = </span><span class="nx">Batman</span>
  <span class="nb">window</span>

<span class="nx">$mixin</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span></pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <p>Optionally export global sugar. Not sure what to do with this.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.exportHelpers = </span><span class="nf">(onto) -&gt;</span>
  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;mixin&#39;</span><span class="p">,</span> <span class="s1">&#39;unmixin&#39;</span><span class="p">,</span> <span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="s1">&#39;redirect&#39;</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;eventOneShot&#39;</span><span class="p">,</span> <span class="s1">&#39;typeOf&#39;</span><span class="p">,</span> <span class="s1">&#39;redirect&#39;</span><span class="p">]</span>
    <span class="nx">onto</span><span class="p">[</span><span class="s2">&quot;$#{k}&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Batman</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
  <span class="nx">onto</span>

<span class="nv">Batman.exportGlobals = </span><span class="nf">() -&gt;</span>
  <span class="nx">Batman</span><span class="p">.</span><span class="nx">exportHelpers</span><span class="p">(</span><span class="nx">container</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 